<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tango Ticket Sales</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        #transactionStatus {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <h1>Buenos Tickets - Customer (Pyth, x402 and Hardhat)</h1>

    <!-- ==================== Section 1: Ticket Purchase ==================== -->
    <div class="section">
        <h2>üé´ Ticket Purchase</h2>
        <p><strong>Description:</strong> Blah blah blah</p>
        
        <button id="payTicketBtn" style="
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        ">
            Pay Ticket
        </button>

        <button id="payTicketWithoutX402Btn" style="
            background-color: #2196F3;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        ">
            Pay Ticket without x402
        </button>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="approveBtn" style="
                background-color: #FF9800;
                color: white;
                padding: 15px 32px;
                text-align: center;
                font-size: 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                flex: 1;
            ">
                Approve USDC
            </button>

            <button id="callMethodBtn" style="
                background-color: #9C27B0;
                color: white;
                padding: 15px 32px;
                text-align: center;
                font-size: 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                flex: 1;
            ">
                Call reserveTicket()
            </button>
        </div>

        <div id="transactionStatus" style="margin-top: 15px; padding: 10px; display: none;"></div>
    </div>

    <!-- ==================== Section 2: Configuration ==================== -->
    <div class="section">
        <h2>Configuration</h2>
        <p><strong>Description:</strong> Basic settings for x402 payment. You can modify these values if needed.</p>
        
        <h3>RPC Node Information</h3>
        <ul>
            <li>Chain ID : <input type="text" id="chainId" value="" /></li>
            <li>RPC URL : <input type="text" id="rpcUrl" value="" /></li>
        </ul>

        <h3>BuenosTickets Smart Contract Address</h3>
        <ul>
            <li>BuenosTickets Contract Address : <input type="text" id="contractAddress" value="" /></li>
        </ul>

        <h3>Facilitator Information</h3>
        <ul>
            <li>Facilitator Address: <input type="text" id="facilitatorAddress" value="" /></li>
            <li>Facilitator API Endpoint: <input type="text" id="facilitatorApiEndpoint" value="" /></li>
        </ul>
    </div>

    <!-- ==================== Section 3: Contract State Information ==================== -->
    <div class="section">
        <h2>üìä BuenosTickets Contract State</h2>
        <p><strong>Description:</strong> Real-time status information retrieved from the smart contract.</p>
        
        <ul>
            <li><strong>Deadline:</strong> <span id="deadline">[Query from contract]</span></li>
            <li><strong>Total Tickets for Sale:</strong> <span id="totalTickets">[Query from contract]</span></li>
            <li><strong>Number of Buyers:</strong> <span id="buyerCount">[Query from contract]</span></li>
        </ul>
    </div>

    <!-- ==================== Section 4: Event Information ==================== -->
    <div class="section">
        <h2>üé≠ Event Information</h2>
        <p><strong>Description:</strong> Blah blah blah</p>
        
        <!-- TODO: Display event poster image -->
        <div>
            <h3>Poster</h3>
            
            <p><img src="assets/img/tango-poster-generated-gemini-ai.png" alt="" style="max-width: 100%;" /></p>
        </div>

        <!-- TODO: Display event details -->
        <div>
            <h3>Title</h3>
            <p id="eventTitle">Blah blah blah</p>

            <h3>Description</h3>
            <p id="eventDescription">Blah blah blah</p>

            <h3>Ticket Price</h3>
            <p id="ticketPrice">0.01 USDC</p>

            <h3>Deadline</h3>
            <p id="eventDeadline">12 Dec 2025</p>
        </div>
    </div>

    <script>
        // Base Sepolia Network Configuration
        const BASE_SEPOLIA_CONFIG = {
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // USDC Contract on Base Sepolia
        const USDC_CONTRACT_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e'; // Base Sepolia USDC
        
        // BuenosTickets Contract Address (ÏûÑÏãú)
        const BUENOS_TICKETS_CONTRACT_ADDRESS = '0x0000000000000000000000000000000000022222';
        
        const RECIPIENT_ADDRESS = '0xefa21bf6343748f95f6949f7aaa7df88f0ee6992';
        const AMOUNT = '0.001'; // USDC amount
        const TICKET_PRICE = '0.01'; // Fixed ticket price in USDC (for testing)

        // ERC20 ABI
        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function balanceOf(address account) view returns (uint256)',
            'function symbol() view returns (string)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        // BuenosTickets Contract ABI
        const BUENOS_TICKETS_ABI = [
            'function reserveTicket() external',
            'function ticketPrice() view returns (uint256)',
            'function endBlock() view returns (uint256)',
            'function maxTickets() view returns (uint256)',
            'function totalReserved() view returns (uint256)',
            'function getUserStatus(address user) view returns (uint8)',
            'function usdcToken() view returns (address)'
        ];

        // Helper function to switch to Base Sepolia
        async function switchToBaseSepolia() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const currentChainId = '0x' + network.chainId.toString(16);

            if (currentChainId !== BASE_SEPOLIA_CONFIG.chainId) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CONFIG.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        // Approve Button Handler
        document.getElementById('approveBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `üîÑ Getting token information...`;
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();

                // Use fixed ticket price
                const ticketPriceInUnits = ethers.utils.parseUnits(TICKET_PRICE, decimals);

                statusDiv.innerHTML = `üîÑ Approving ${TICKET_PRICE} ${symbol} to BuenosTickets contract...<br>Please confirm in MetaMask`;

                // Approve USDC to BuenosTickets contract
                const tx = await usdcContract.approve(BUENOS_TICKETS_CONTRACT_ADDRESS, ticketPriceInUnits);
                
                statusDiv.innerHTML = `üîÑ Approval submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Approval successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Amount: ${TICKET_PRICE} ${symbol}<br>
                    Spender: BuenosTickets Contract<br>
                    <small>Note: Deploy BuenosTickets contract before calling reserveTicket()</small>`;

            } catch (error) {
                console.error('Approval error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Approval failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Call reserveTicket() Button Handler
        document.getElementById('callMethodBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                statusDiv.innerHTML = `üîÑ Calling reserveTicket()...<br>Please confirm in MetaMask`;

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                // Call reserveTicket()
                const tx = await buenosTicketsContract.reserveTicket();
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Ticket reserved successfully!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}`;

            } catch (error) {
                console.error('reserveTicket error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else if (error.code === 'CALL_EXCEPTION' || (error.message && error.message.includes('CALL_EXCEPTION'))) {
                    errorMessage = '‚ùå BuenosTickets contract not deployed yet. Please deploy the contract first.';
                } else if (error.message && error.message.includes('already reserved')) {
                    errorMessage = '‚ùå Ticket already reserved';
                } else if (error.message && error.message.includes('Sale period has ended')) {
                    errorMessage = '‚ùå Sale period has ended';
                } else if (error.message && error.message.includes('Check approval')) {
                    errorMessage = '‚ùå Insufficient USDC approval. Please click "Approve USDC" first';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Pay Ticket without x402 Button Handler
        document.getElementById('payTicketWithoutX402Btn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                // Check if ethers.js is loaded
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                // Request account access
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `üîÑ Getting token information...`;
                
                // Get token decimals and symbol
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                
                // Convert amount to proper units
                const amountInUnits = ethers.utils.parseUnits(AMOUNT, decimals);

                statusDiv.innerHTML = `üîÑ Sending ${AMOUNT} ${symbol} to ${RECIPIENT_ADDRESS}...<br>Please confirm in MetaMask`;

                // Send USDC transaction
                const tx = await usdcContract.transfer(RECIPIENT_ADDRESS, amountInUnits);
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                // Wait for transaction to be mined
                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Transaction successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    Amount: ${AMOUNT} ${symbol}`;

            } catch (error) {
                console.error('Transaction error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else if (error.code === -32603) {
                    errorMessage = '‚ùå Insufficient USDC balance or gas (ETH)';
                } else if (error.code === 4902) {
                    errorMessage = '‚ùå Failed to add Base Sepolia network';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMessage = '‚ùå Insufficient USDC balance or ETH for gas';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });
    </script>

</body>
</html>
