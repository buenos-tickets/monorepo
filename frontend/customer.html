<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tango Ticket Sales</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #f0f0f0;
            color: #666;
        }
        #transactionStatus {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <h1>Buenos Tickets - Customer</h1>

    <!-- ==================== Section 1: Smart Contract Functions ==================== -->
    <div class="section">
        <h2>ğŸ”— ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ</h2>
        <p><strong>ì„¤ëª…:</strong> BuenosTickets ì»¨íŠ¸ë™íŠ¸ì™€ ì§ì ‘ í†µì‹ í•©ë‹ˆë‹¤.</p>

        <div style="margin-bottom: 20px; padding: 15px; background-color: #e8f4f8; border-radius: 5px; border-left: 4px solid #2196F3;">
            <h3 style="margin-top: 0; color: #1976D2;">ğŸ“ í™˜ê²½ ì •ë³´</h3>
            <ul style="margin: 10px 0;">
                <li><strong>Network:</strong> Base Sepolia (Chain ID: 84532)</li>
                <li><strong>Smart Contract Address:</strong> <code style="background: white; padding: 2px 6px; border-radius: 3px;">0x55Cf458212822b33d8485969f4616FA8D9b6e1A7</code></li>
            </ul>
            <button id="viewMyAddressBtn" style="
                background-color: #1976D2;
                color: white;
                padding: 10px 20px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
                width: 100%;
            ">
                ğŸ” Base Sepolia Explorerì—ì„œ ë‚´ ì£¼ì†Œ ë³´ê¸°
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            
            <!-- getSaleInfo & getUserStatus Buttons (in one row) -->
            <div style="display: flex; gap: 15px;">
                <!-- getSaleInfo Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-top: 0; color: #555;">ğŸ“Š getSaleInfo()</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">íŒë§¤ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤ (ì½ê¸° ì „ìš©)</p>
                    <button id="getSaleInfoBtn" style="
                        background-color: #17a2b8;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Get Sale Info
                    </button>
                </div>

                <!-- getUserStatus Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #6c757d;">
                    <h4 style="margin-top: 0; color: #555;">ğŸ‘¤ getUserStatus(address user)</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">ë‚´ ì˜ˆì•½ ìƒíƒœë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤ (ì½ê¸° ì „ìš©)</p>
                    <button id="getUserStatusBtn" style="
                        background-color: #6c757d;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Get My Status
                    </button>
                </div>
            </div>

            <!-- Approve USDC & Reserve Ticket (2-step process in one row) -->
            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #fff9e6; border-left: 4px solid #FF9800;">
                <h4 style="margin-top: 0; color: #555;">ğŸ« í‹°ì¼“ ì˜ˆì•½ (2ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤)</h4>
                <p style="font-size: 0.9em; color: #666; margin: 5px 0 15px 0;">USDC ìŠ¹ì¸ í›„ í‹°ì¼“ì„ ì˜ˆì•½í•©ë‹ˆë‹¤</p>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <button id="approveBtn" style="
                            background-color: #FF9800;
                            color: white;
                            padding: 12px 24px;
                            font-size: 14px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            1. Approve USDC
                        </button>
                    </div>
                    <div style="flex: 1;">
                        <button id="callMethodBtn" style="
                            background-color: #4CAF50;
                            color: white;
                            padding: 12px 24px;
                            font-size: 14px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            2. Reserve Ticket
                        </button>
                    </div>
                </div>
            </div>

            <!-- refund & spinWheel Buttons (in one row) -->
            <div style="display: flex; gap: 15px;">
                <!-- refund Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #dc3545;">
                    <h4 style="margin-top: 0; color: #555;">ğŸ’¸ refund()</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">ë‹¹ì²¨ë˜ì§€ ì•Šì€ ê²½ìš° í™˜ë¶ˆì„ ë°›ìŠµë‹ˆë‹¤ (íŠ¸ëœì­ì…˜ í•„ìš”)</p>
                    <button id="refundBtn" style="
                        background-color: #dc3545;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Request Refund
                    </button>
                </div>

                <!-- spinWheel Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #2196F3;">
                    <h4 style="margin-top: 0; color: #555;">ğŸ° spinWheel()</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">Pyth Entropyë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¹ì²¨ìë¥¼ ì¶”ì²¨í•©ë‹ˆë‹¤ (Admin ì „ìš©, íŠ¸ëœì­ì…˜ í•„ìš”)</p>
                    <button id="spinWheelBtn" style="
                        background-color: #2196F3;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Spin the Wheel
                    </button>
                </div>
            </div>

        </div>

        <div id="contractCallStatus" style="margin-top: 15px; padding: 15px; display: none; border-radius: 5px;"></div>
    </div>

    <!-- ==================== Section 2: Event Information ==================== -->
    <div class="section">
        <h2>ğŸ’ƒ Event Information</h2>
        <p><strong>Description:</strong> ì•„ë¥´í—¨í‹°ë‚˜ì˜ ì—´ì •ì´ ë‹´ê¸´ íƒ±ê³  ê³µì—° í‹°ì¼“ì„ ì˜ˆì•½í•˜ì„¸ìš”</p>
        
        <!-- Display event poster image -->
        <div>
            <h3>Poster</h3>
            
            <p><img src="assets/img/tango-poster-generated-gemini-ai.png" alt="Buenos Aires Tango Night" style="max-width: 100%;" /></p>
        </div>

        <!-- Display event details -->
        <div>
            <h3>Title</h3>
            <p id="eventTitle">Buenos Aires Tango Night</p>

            <h3>Description</h3>
            <p id="eventDescription">ì„¸ê³„ì ì¸ íƒ±ê³  ëŒ„ì„œë“¤ì´ ì„ ì‚¬í•˜ëŠ” ì—´ì •ì ì¸ ë¬´ëŒ€. ë¶€ì—ë…¸ìŠ¤ì•„ì´ë ˆìŠ¤ì˜ ë°¤ì„ ì„œìš¸ì—ì„œ ë§Œë‚˜ë³´ì„¸ìš”. ë¼ì´ë¸Œ ë°´ë“œ ì—°ì£¼ì™€ í•¨ê»˜í•˜ëŠ” í´ë˜ì‹ íƒ±ê³  í¼í¬ë¨¼ìŠ¤ë¥¼ ê²½í—˜í•  ìˆ˜ ìˆëŠ” íŠ¹ë³„í•œ ê¸°íšŒì…ë‹ˆë‹¤.</p>

            <h3>Ticket Price</h3>
            <p id="ticketPrice">0.01 USDC</p>
        </div>
    </div>

    <!-- ==================== Section 3: Configuration ==================== -->
    <div class="section">
        <h2>âš™ï¸ Configuration</h2>
        <p><strong>Description:</strong> Network and facilitator settings for x402 payment protocol. Pre-configured for Base Sepolia testnet.</p>
        
        <h3>RPC Node Information</h3>
        <ul>
            <li>Chain ID : <input type="text" id="chainId" value="84532" readonly /> <small>(Base Sepolia)</small></li>
            <li>RPC URL : <input type="text" id="rpcUrl" value="https://sepolia.base.org" readonly /></li>
        </ul>

        <h3>BuenosTickets Smart Contract Address</h3>
        <ul>
            <li>BuenosTickets Contract Address : <input type="text" id="contractAddress" value="0x55Cf458212822b33d8485969f4616FA8D9b6e1A7" readonly /></li>
        </ul>

        <h3>Facilitator Information (for x402 payment)</h3>
        <ul>
            <li>Network: <input type="text" id="facilitatorNetwork" value="base-sepolia" readonly /> <small>(baseSepolia)</small></li>
            <li>Facilitator URL: <input type="text" id="facilitatorApiEndpoint" value="http://localhost:3001/api/x402/submit" placeholder="http://localhost:3001/api/x402/submit" /></li>
            <li>Resource Wallet Address: <input type="text" id="facilitatorAddress" value="0xEfA21bF6343748f95F6949f7aAa7DF88F0eE6992" placeholder="0x..." /></li>
            <li>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="testMode" style="width: auto;" />
                    <span>Test Mode (Skip Facilitator, simulate response)</span>
                </label>
            </li>
        </ul>
        <p style="font-size: 0.9em; color: #666;">
            <strong>Note:</strong> Configure Facilitator settings to use "Pay Ticket (x402 - Gasless)" button. 
            The Facilitator will pay gas fees on your behalf.
        </p>
        <p style="font-size: 0.85em; color: #999;">
            <strong>Default Configuration:</strong><br>
            â€¢ Network: Base Sepolia (ChainID: 84532)<br>
            â€¢ Facilitator URL: http://localhost:3001 (run your own facilitator)<br>
            â€¢ Resource Wallet: Your address (receives payments)<br>
            â€¢ <strong>Test Mode:</strong> Enable to simulate x402 without real facilitator
        </p>
        <p style="font-size: 0.85em; color: #f39c12; background-color: #fff3cd; padding: 8px; border-radius: 4px;">
            âš ï¸ <strong>Quick Start:</strong> Check "Test Mode" to try x402 flow without setting up a facilitator server.
        </p>
    </div>

    <!-- ==================== Section 4: Ticket Purchase ==================== -->
    <div class="section">
        <h2>ğŸ« Ticket Purchase</h2>
        <p><strong>Description:</strong> Choose your payment method below. x402 allows gasless transactions through a Facilitator.</p>
        <p style="font-size: 0.9em; color: #666;"><strong>ğŸ’¡ Tip:</strong> ê°œë³„ ì»¨íŠ¸ë™íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ(Approve, Reserve)ì€ "ğŸ”— ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ" ì„¹ì…˜ì„ ì´ìš©í•˜ì„¸ìš”.</p>
        
        <button id="payTicketBtn" style="
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        ">
            Pay Ticket (x402 - Gasless)
        </button>

        <button id="payTicketWithoutX402Btn" style="
            background-color: #2196F3;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        ">
            Direct USDC Transfer (You pay gas)
        </button>

        <div id="transactionStatus" style="margin-top: 15px; padding: 10px; display: none;"></div>
    </div>

    <script>
        // Base Sepolia Network Configuration
        const BASE_SEPOLIA_CONFIG = {
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // USDC Contract on Base Sepolia
        const USDC_CONTRACT_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e'; // Base Sepolia USDC
        
        // BuenosTickets Contract Address
        const BUENOS_TICKETS_CONTRACT_ADDRESS = '0x55Cf458212822b33d8485969f4616FA8D9b6e1A7';
        
        const RECIPIENT_ADDRESS = '0xefa21bf6343748f95f6949f7aaa7df88f0ee6992';
        const AMOUNT = '0.001'; // USDC amount
        const TICKET_PRICE = '0.01'; // Fixed ticket price in USDC (for testing)
        const APPROVAL_AMOUNT = '1000'; // USDC approval amount for Approve button

        // ERC20 ABI
        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function balanceOf(address account) view returns (uint256)',
            'function symbol() view returns (string)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        // BuenosTickets Contract ABI
        const BUENOS_TICKETS_ABI = [
            'function reserveTicket() external',
            'function ticketPrice() view returns (uint256)',
            'function endBlock() view returns (uint256)',
            'function maxTickets() view returns (uint256)',
            'function totalReserved() view returns (uint256)',
            'function getUserStatus(address user) view returns (uint8)',
            'function usdcToken() view returns (address)',
            'function refund() external',
            'function getSaleInfo() external view returns (uint256 _endBlock, uint256 _ticketPrice, uint256 _maxTickets, uint256 _totalReserved, bool _isSettled)',
            'function isSettled() view returns (bool)',
            'function spinWheel() external'
        ];

        // Helper function to switch to Base Sepolia
        async function switchToBaseSepolia() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const currentChainId = '0x' + network.chainId.toString(16);

            if (currentChainId !== BASE_SEPOLIA_CONFIG.chainId) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CONFIG.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        // Pay Ticket (x402 flow) Button Handler
        document.getElementById('payTicketBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Get Facilitator configuration
                const facilitatorNetwork = document.getElementById('facilitatorNetwork').value || 'base-sepolia';
                const facilitatorEndpoint = document.getElementById('facilitatorApiEndpoint').value;
                const facilitatorAddress = document.getElementById('facilitatorAddress').value;
                const testMode = document.getElementById('testMode').checked;

                if (!testMode) {
                    if (!facilitatorEndpoint || facilitatorEndpoint.trim() === '') {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = 'âŒ Please configure Facilitator API Endpoint in the Configuration section or enable Test Mode';
                        return;
                    }

                    if (!facilitatorAddress || facilitatorAddress.trim() === '') {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = 'âŒ Please configure Resource Wallet Address in the Configuration section';
                        return;
                    }
                }

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);

                statusDiv.innerHTML = `ğŸ”„ Preparing payment data...`;

                // Get ticket price (use fixed price for now)
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                const ticketPriceInUnits = ethers.utils.parseUnits(TICKET_PRICE, decimals);

                // Create transaction data for reserveTicket()
                const txData = buenosTicketsContract.interface.encodeFunctionData('reserveTicket');

                // Prepare transaction object
                const tx = {
                    from: userAddress,
                    to: BUENOS_TICKETS_CONTRACT_ADDRESS,
                    data: txData,
                    value: '0x0',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                };

                // Get current gas price and nonce
                const gasPrice = await provider.getGasPrice();
                const nonce = await provider.getTransactionCount(userAddress, 'latest');

                tx.gasPrice = gasPrice.toHexString();
                tx.nonce = nonce;
                tx.gasLimit = ethers.utils.hexlify(100000); // Estimate

                statusDiv.innerHTML = `ğŸ”„ Creating signed transaction...<br>Please sign in MetaMask (no gas required now)`;

                // Sign the transaction (EIP-712 typed data)
                // For x402, we create a payment request signature
                const domain = {
                    name: 'Buenos Tickets x402',
                    version: '1',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    verifyingContract: BUENOS_TICKETS_CONTRACT_ADDRESS
                };

                const types = {
                    PaymentRequest: [
                        { name: 'from', type: 'address' },
                        { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'data', type: 'bytes' },
                        { name: 'nonce', type: 'uint256' },
                        { name: 'deadline', type: 'uint256' }
                    ]
                };

                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 hour from now

                const value = {
                    from: userAddress,
                    to: BUENOS_TICKETS_CONTRACT_ADDRESS,
                    value: 0,
                    data: txData,
                    nonce: nonce,
                    deadline: deadline
                };

                // Sign typed data
                const signature = await signer._signTypedData(domain, types, value);

                // Prepare payload for facilitator
                const payload = {
                    type: 'x402-payment',
                    network: facilitatorNetwork,
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    transaction: tx,
                    signature: signature,
                    signedData: {
                        domain,
                        types,
                        value
                    },
                    payment: {
                        amount: TICKET_PRICE,
                        currency: symbol,
                        description: 'Buenos Tickets - Tango Event',
                        from: userAddress,
                        to: facilitatorAddress
                    }
                };

                let facilitatorResult;

                if (testMode) {
                    // Test mode: Simulate facilitator response
                    statusDiv.innerHTML = `ğŸ”„ TEST MODE: Simulating facilitator response...<br>No actual transaction will be sent`;
                    
                    console.log('ğŸ§ª TEST MODE ENABLED');
                    console.log('ğŸ“¦ Payload that would be sent:', payload);
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    facilitatorResult = {
                        success: true,
                        txHash: '0x' + '0'.repeat(64), // Mock transaction hash
                        message: 'Test mode: Transaction simulated',
                        timestamp: Date.now()
                    };
                    
                    console.log('âœ… Simulated response:', facilitatorResult);

                } else {
                    // Real mode: Send to actual facilitator
                    statusDiv.innerHTML = `ğŸ”„ Sending payment request to Facilitator...<br>Facilitator will broadcast the transaction`;
                    
                    console.log('ğŸ“¤ Sending to facilitator:', facilitatorEndpoint);
                    console.log('ğŸ“¦ Payload:', payload);
                    
                    const facilitatorResponse = await fetch(facilitatorEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    }).catch(fetchError => {
                        console.error('âŒ Fetch error:', fetchError);
                        throw new Error(`Cannot connect to Facilitator. Please check:\n1. Facilitator URL is correct\n2. Facilitator service is running\n3. CORS is properly configured\n\nError: ${fetchError.message}`);
                    });

                    if (!facilitatorResponse.ok) {
                        const errorText = await facilitatorResponse.text();
                        console.error('âŒ Facilitator response error:', errorText);
                        throw new Error(`Facilitator error: ${facilitatorResponse.status} ${facilitatorResponse.statusText}\nDetails: ${errorText}`);
                    }

                    facilitatorResult = await facilitatorResponse.json();
                    console.log('âœ… Facilitator response:', facilitatorResult);
                }

                statusDiv.innerHTML = `ğŸ”„ ${testMode ? 'Simulated' : 'Facilitator'} processing...<br>Transaction hash: ${facilitatorResult.txHash || 'pending'}`;

                // Wait a bit for confirmation
                await new Promise(resolve => setTimeout(resolve, 2000));

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… Payment ${testMode ? 'simulated' : 'submitted'} via x402!<br>
                    ${testMode ? '<strong>âš ï¸ TEST MODE - No real transaction</strong><br>' : ''}
                    Transaction: ${facilitatorResult.txHash ? `<a href="https://sepolia.basescan.org/tx/${facilitatorResult.txHash}" target="_blank" style="color: #155724;">${facilitatorResult.txHash.substring(0, 20)}...</a>` : 'Processing'}<br>
                    ${testMode ? '' : `Facilitator: ${facilitatorAddress}<br>`}
                    Amount: ${TICKET_PRICE} ${symbol}<br>
                    <small>${testMode ? 'Test mode enabled - Check console for details' : 'Facilitator pays gas fees on your behalf'}</small>`;

            } catch (error) {
                console.error('x402 Payment error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'x402 Payment failed!';
                if (error.code === 4001) {
                    errorMessage = 'âŒ Signature rejected by user';
                } else if (error.message && error.message.includes('Facilitator')) {
                    errorMessage = `âŒ Facilitator error: ${error.message}`;
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = 'âŒ Network error: Check Facilitator endpoint';
                } else {
                    errorMessage = `âŒ Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Approve Button Handler
        document.getElementById('approveBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `ğŸ”„ Getting token information...`;
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();

                // Use approval amount (1000 USDC)
                const approvalAmountInUnits = ethers.utils.parseUnits(APPROVAL_AMOUNT, decimals);

                statusDiv.innerHTML = `ğŸ”„ Approving ${APPROVAL_AMOUNT} ${symbol} to BuenosTickets contract...<br>Please confirm in MetaMask`;

                // Approve USDC to BuenosTickets contract
                const tx = await usdcContract.approve(BUENOS_TICKETS_CONTRACT_ADDRESS, approvalAmountInUnits);
                
                statusDiv.innerHTML = `ğŸ”„ Approval submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… Approval successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Amount: ${APPROVAL_AMOUNT} ${symbol}<br>
                    Spender: BuenosTickets Contract<br>
                    <small>ì´ì œ ì—¬ëŸ¬ ë²ˆì˜ í‹°ì¼“ ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ìŠ¹ì¸ í•œë„: ${APPROVAL_AMOUNT} USDC)</small>`;

            } catch (error) {
                console.error('Approval error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Approval failed!';
                if (error.code === 4001) {
                    errorMessage = 'âŒ Transaction rejected by user';
                } else {
                    errorMessage = `âŒ Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Call reserveTicket() Button Handler
        document.getElementById('callMethodBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                statusDiv.innerHTML = `ğŸ”„ Calling reserveTicket()...<br>Please confirm in MetaMask`;

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                // Call reserveTicket()
                const tx = await buenosTicketsContract.reserveTicket();
                
                statusDiv.innerHTML = `ğŸ”„ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… Ticket reserved successfully!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}`;

            } catch (error) {
                console.error('reserveTicket error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = 'âŒ Transaction rejected by user';
                } else if (error.code === 'CALL_EXCEPTION' || (error.message && error.message.includes('CALL_EXCEPTION'))) {
                    errorMessage = 'âŒ BuenosTickets contract not deployed yet. Please deploy the contract first.';
                } else if (error.message && error.message.includes('already reserved')) {
                    errorMessage = 'âŒ Ticket already reserved';
                } else if (error.message && error.message.includes('Sale period has ended')) {
                    errorMessage = 'âŒ Sale period has ended';
                } else if (error.message && error.message.includes('Check approval')) {
                    errorMessage = 'âŒ Insufficient USDC approval. Please click "Approve USDC" first';
                } else {
                    errorMessage = `âŒ Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Pay Ticket without x402 Button Handler
        document.getElementById('payTicketWithoutX402Btn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                // Check if ethers.js is loaded
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ Connecting to MetaMask...';

                // Request account access
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `ğŸ”„ Getting token information...`;
                
                // Get token decimals and symbol
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                
                // Convert amount to proper units
                const amountInUnits = ethers.utils.parseUnits(AMOUNT, decimals);

                statusDiv.innerHTML = `ğŸ”„ Sending ${AMOUNT} ${symbol} to ${RECIPIENT_ADDRESS}...<br>Please confirm in MetaMask`;

                // Send USDC transaction
                const tx = await usdcContract.transfer(RECIPIENT_ADDRESS, amountInUnits);
                
                statusDiv.innerHTML = `ğŸ”„ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                // Wait for transaction to be mined
                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… Transaction successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    Amount: ${AMOUNT} ${symbol}`;

            } catch (error) {
                console.error('Transaction error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = 'âŒ Transaction rejected by user';
                } else if (error.code === -32603) {
                    errorMessage = 'âŒ Insufficient USDC balance or gas (ETH)';
                } else if (error.code === 4902) {
                    errorMessage = 'âŒ Failed to add Base Sepolia network';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMessage = 'âŒ Insufficient USDC balance or ETH for gas';
                } else {
                    errorMessage = `âŒ Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // ==================== New Smart Contract Function Handlers ====================
        
        // Helper function for status display
        function getStatusText(statusCode) {
            const statuses = ['Unreserved', 'Reserved', 'Selected', 'Refunded'];
            return statuses[statusCode] || 'Unknown';
        }

        // View My Address in Explorer Button Handler
        document.getElementById('viewMyAddressBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('ë©”íƒ€ë§ˆìŠ¤í¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!');
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                // Open Base Sepolia explorer in new tab
                const explorerUrl = `https://sepolia.basescan.org/address/${userAddress}`;
                window.open(explorerUrl, '_blank');

            } catch (error) {
                console.error('View address error:', error);
                if (error.code === 4001) {
                    alert('âŒ ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²°ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    alert(`âŒ ì—ëŸ¬: ${error.message}`);
                }
            }
        });

        // getSaleInfo Button Handler
        document.getElementById('getSaleInfoBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('ë©”íƒ€ë§ˆìŠ¤í¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ ì»¨íŠ¸ë™íŠ¸ ì—°ê²° ì¤‘...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await switchToBaseSepolia();

                // Connect to BuenosTickets contract (read-only)
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                statusDiv.innerHTML = 'ğŸ”„ getSaleInfo() í˜¸ì¶œ ì¤‘...';

                const saleInfo = await contract.getSaleInfo();
                
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… íŒë§¤ ì •ë³´ ì¡°íšŒ ì„±ê³µ!<br><br>
                    <strong>ğŸ“Š Sale Information:</strong><br>
                    â€¢ <strong>End Block:</strong> ${saleInfo._endBlock.toString()}<br>
                    â€¢ <strong>Ticket Price:</strong> ${ethers.utils.formatUnits(saleInfo._ticketPrice, 6)} USDC<br>
                    â€¢ <strong>Max Tickets:</strong> ${saleInfo._maxTickets.toString()}<br>
                    â€¢ <strong>Total Reserved:</strong> ${saleInfo._totalReserved.toString()}<br>
                    â€¢ <strong>Is Settled:</strong> ${saleInfo._isSettled ? 'Yes âœ…' : 'No âŒ'}`;

            } catch (error) {
                console.error('getSaleInfo error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `âŒ ì—ëŸ¬: ${error.message}`;
            }
        });

        // getUserStatus Button Handler
        document.getElementById('getUserStatusBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('ë©”íƒ€ë§ˆìŠ¤í¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²° ì¤‘...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ ì—°ê²°ë¨: ${userAddress}<br>ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì¤‘...`;

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract (read-only)
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                statusDiv.innerHTML = `ğŸ”„ getUserStatus() í˜¸ì¶œ ì¤‘...`;

                const status = await contract.getUserStatus(userAddress);
                const statusText = getStatusText(status);
                
                // Status color coding
                let statusEmoji = 'â“';
                let statusColor = '#666';
                if (status === 0) { statusEmoji = 'âšª'; statusColor = '#6c757d'; } // Unreserved
                else if (status === 1) { statusEmoji = 'ğŸŸ¡'; statusColor = '#ffc107'; } // Reserved
                else if (status === 2) { statusEmoji = 'ğŸŸ¢'; statusColor = '#28a745'; } // Selected
                else if (status === 3) { statusEmoji = 'ğŸ”´'; statusColor = '#dc3545'; } // Refunded

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… ë‚´ ìƒíƒœ ì¡°íšŒ ì„±ê³µ!<br><br>
                    <strong>ğŸ‘¤ My Status:</strong><br>
                    â€¢ <strong>Address:</strong> ${userAddress}<br>
                    â€¢ <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusEmoji} ${statusText} (${status})</span><br><br>
                    <small>
                        <strong>Status ì„¤ëª…:</strong><br>
                        0 = Unreserved (ì˜ˆì•½ ì•ˆí•¨) âšª<br>
                        1 = Reserved (ì˜ˆì•½ë¨, ì¶”ì²¨ ëŒ€ê¸°) ğŸŸ¡<br>
                        2 = Selected (ë‹¹ì²¨!) ğŸŸ¢<br>
                        3 = Refunded (í™˜ë¶ˆ ì™„ë£Œ) ğŸ”´
                    </small>`;

            } catch (error) {
                console.error('getUserStatus error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `âŒ ì—ëŸ¬: ${error.message}`;
            }
        });

        // refund Button Handler
        document.getElementById('refundBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('ë©”íƒ€ë§ˆìŠ¤í¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²° ì¤‘...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ ì—°ê²°ë¨: ${userAddress}<br>ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì¤‘...`;

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                // ì‚¬ì „ ì²´í¬ 1: ì¶”ì²¨ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
                statusDiv.innerHTML = 'ğŸ”„ ì»¨íŠ¸ë™íŠ¸ ìƒíƒœ í™•ì¸ ì¤‘...';
                const isSettled = await contract.isSettled();
                
                if (!isSettled) {
                    statusDiv.style.backgroundColor = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.innerHTML = `âš ï¸ <strong>í™˜ë¶ˆ ë¶ˆê°€</strong><br><br>
                        ì¶”ì²¨ì´ ì•„ì§ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                        ì¶”ì²¨ ì™„ë£Œ í›„ í™˜ë¶ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br><br>
                        <small>ğŸ’¡ <strong>Tip:</strong> "Get Sale Info" ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.<br>
                        Is Settledê°€ "Yes"ë¡œ ë³€ê²½ë˜ë©´ í™˜ë¶ˆì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>`;
                    return;
                }

                // ì‚¬ì „ ì²´í¬ 2: ì‚¬ìš©ìì˜ ì˜ˆì•½ ìƒíƒœ í™•ì¸
                statusDiv.innerHTML = 'ğŸ”„ ì‚¬ìš©ì ì˜ˆì•½ ìƒíƒœ í™•ì¸ ì¤‘...';
                const userStatus = await contract.getUserStatus(userAddress);
                
                if (userStatus === 0) {
                    statusDiv.style.backgroundColor = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.innerHTML = `âš ï¸ <strong>í™˜ë¶ˆ ë¶ˆê°€</strong><br><br>
                        ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        í™˜ë¶ˆì„ ë°›ìœ¼ë ¤ë©´ ë¨¼ì € í‹°ì¼“ì„ ì˜ˆì•½í•´ì•¼ í•©ë‹ˆë‹¤.`;
                    return;
                }

                if (userStatus === 2) {
                    statusDiv.style.backgroundColor = '#d1ecf1';
                    statusDiv.style.color = '#0c5460';
                    statusDiv.innerHTML = `ğŸ‰ <strong>ì¶•í•˜í•©ë‹ˆë‹¤!</strong><br><br>
                        ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                        ë‹¹ì²¨ìëŠ” í™˜ë¶ˆì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br>
                        <small>ğŸ’¡ í‹°ì¼“ êµ¬ë§¤ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</small>`;
                    return;
                }

                if (userStatus === 3) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `âœ… ì´ë¯¸ í™˜ë¶ˆì„ ë°›ì•˜ìŠµë‹ˆë‹¤.<br><br>
                        ì¤‘ë³µ í™˜ë¶ˆì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`;
                    return;
                }

                // ì‚¬ì „ ì²´í¬ í†µê³¼ - ì´ì œ MetaMask íŒì—…ì´ ëœ¹ë‹ˆë‹¤
                statusDiv.innerHTML = 'ğŸ”„ refund() í˜¸ì¶œ ì¤‘...<br><strong>ë©”íƒ€ë§ˆìŠ¤í¬ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”</strong>';

                // Call refund()
                const tx = await contract.refund();
                
                statusDiv.innerHTML = `ğŸ”„ íŠ¸ëœì­ì…˜ ì œì¶œë¨!<br>Hash: ${tx.hash}<br>í™•ì¸ ëŒ€ê¸° ì¤‘...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… í™˜ë¶ˆ ì„±ê³µ!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    <small>í™˜ë¶ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. USDCê°€ ê·€í•˜ì˜ ì§€ê°‘ìœ¼ë¡œ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.</small>`;

            } catch (error) {
                console.error('refund error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'í™˜ë¶ˆ ì‹¤íŒ¨!';
                if (error.code === 4001) {
                    errorMessage = 'âŒ ì‚¬ìš©ìê°€ íŠ¸ëœì­ì…˜ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('No active reservation')) {
                    errorMessage = 'âŒ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('User was either selected or already refunded')) {
                    errorMessage = 'âŒ ì´ë¯¸ ë‹¹ì²¨ë˜ì—ˆê±°ë‚˜ í™˜ë¶ˆì„ ë°›ì•˜ìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('Sale must be settled first')) {
                    errorMessage = 'âŒ ì¶”ì²¨ì´ ì•„ì§ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¶”ì²¨ ì™„ë£Œ í›„ í™˜ë¶ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                } else {
                    errorMessage = `âŒ ì—ëŸ¬: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // spinWheel Button Handler
        document.getElementById('spinWheelBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('ë©”íƒ€ë§ˆìŠ¤í¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'ğŸ”„ ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²° ì¤‘...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `ğŸ”„ ì—°ê²°ë¨: ${userAddress}<br>ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì¤‘...`;

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                statusDiv.innerHTML = 'ğŸ”„ spinWheel() í˜¸ì¶œ ì¤‘...<br><strong>ë©”íƒ€ë§ˆìŠ¤í¬ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”</strong><br><br><small>âš ï¸ Admin ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</small>';

                // Call spinWheel()
                const tx = await contract.spinWheel();
                
                statusDiv.innerHTML = `ğŸ”„ íŠ¸ëœì­ì…˜ ì œì¶œë¨!<br>Hash: ${tx.hash}<br>í™•ì¸ ëŒ€ê¸° ì¤‘...<br><small>Pyth Entropyë¥¼ ì‚¬ìš©í•œ ëœë¤ ì¶”ì²¨ ì§„í–‰ ì¤‘...</small>`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `âœ… ì¶”ì²¨ ì™„ë£Œ!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    <small>ğŸ° Pyth Entropyë¥¼ ì‚¬ìš©í•œ ëœë¤ ì¶”ì²¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    ë‹¹ì²¨ìê°€ ì„ ì •ë˜ì—ˆê³ , ë‚™ì²¨ìëŠ” í™˜ë¶ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>`;

            } catch (error) {
                console.error('spinWheel error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'ì¶”ì²¨ ì‹¤íŒ¨!';
                if (error.code === 4001) {
                    errorMessage = 'âŒ ì‚¬ìš©ìê°€ íŠ¸ëœì­ì…˜ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('Only admin')) {
                    errorMessage = 'âŒ Admin ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
                } else if (error.message && error.message.includes('Sale is still active')) {
                    errorMessage = 'âŒ íŒë§¤ ê¸°ê°„ì´ ì•„ì§ ì¢…ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('already settled')) {
                    errorMessage = 'âŒ ì´ë¯¸ ì¶”ì²¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('Invalid Pyth Entropy')) {
                    errorMessage = 'âŒ Pyth Entropy ì½œë°±ì´ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. settleSale() ì‹¤í–‰ í›„ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.';
                } else {
                    errorMessage = `âŒ ì—ëŸ¬: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });
    </script>

</body>
</html>
