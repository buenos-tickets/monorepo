<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tango Ticket Sales</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #f0f0f0;
            color: #666;
        }
        #transactionStatus {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            overflow: hidden;
        }
        
        /* Ìè≠Ï£Ω Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: explode 3s ease-out forwards;
        }
        
        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
        
        .success-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <h1>Buenos Tickets - Customer</h1>

    <!-- ==================== Section 1: Event Information ==================== -->
    <div class="section">
        <h2>üíÉ Event Information</h2>
        <p><strong>Description:</strong> Reserve your ticket for the passionate Argentine Tango performance</p>
        
        <!-- Display event poster image -->
        <div>
            <h3>Poster</h3>
            
            <p><img src="assets/img/tango-poster-generated-gemini-ai.png" alt="Buenos Aires Tango Night" style="max-width: 100%;" /></p>
        </div>

        <!-- Display event details -->
        <div>
            <h3>Title</h3>
            <p id="eventTitle">Buenos Aires Tango Night</p>

            <h3>Description</h3>
            <p id="eventDescription">Experience a passionate stage presented by world-class tango dancers. Meet the night of Buenos Aires in Seoul. A special opportunity to experience classic tango performance with live band music.</p>

            <h3>Ticket Price</h3>
            <p id="ticketPrice">0.01 USDC</p>
        </div>
    </div>

    <!-- ==================== Section 2: Smart Contract Functions ==================== -->
    <div class="section">
        <h2>üîó Smart Contract Functions</h2>
        <p><strong>Description:</strong> Direct communication with BuenosTickets contract.</p>

        <div id="successBanner" style="display: none;"></div>
        
        <div style="margin-bottom: 20px; padding: 15px; background-color: #e8f4f8; border-radius: 5px; border-left: 4px solid #2196F3;">
            <h3 style="margin-top: 0; color: #1976D2;">üìç Environment Info</h3>
            <ul style="margin: 10px 0;">
                <li><strong>Network:</strong> Base Sepolia (Chain ID: 84532)</li>
                <li><strong>Smart Contract Address:</strong> <code style="background: white; padding: 2px 6px; border-radius: 3px;">0x55Cf458212822b33d8485969f4616FA8D9b6e1A7</code></li>
            </ul>
            <button id="viewMyAddressBtn" style="
                background-color: #1976D2;
                color: white;
                padding: 10px 20px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
                width: 100%;
            ">
                üîç View My Address on Base Sepolia Explorer
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            
            <!-- getSaleInfo & getUserStatus Buttons (in one row) -->
            <div style="display: flex; gap: 15px;">
                <!-- getSaleInfo Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-top: 0; color: #555;">üìä getSaleInfo()</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">Query sale information (Read-only)</p>
                    <button id="getSaleInfoBtn" style="
                        background-color: #17a2b8;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Get Sale Info
                    </button>
                </div>

                <!-- getUserStatus Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #6c757d;">
                    <h4 style="margin-top: 0; color: #555;">üë§ getUserStatus(address user)</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">Check my reservation status (Read-only)</p>
                    <button id="getUserStatusBtn" style="
                        background-color: #6c757d;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Get My Status
                    </button>
                </div>
            </div>

            <!-- Approve USDC & Reserve Ticket (2-step process in one row) -->
            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #fff9e6; border-left: 4px solid #FF9800;">
                <h4 style="margin-top: 0; color: #555;">üé´ Reserve Ticket (2-Step Process)</h4>
                <p style="font-size: 0.9em; color: #666; margin: 5px 0 15px 0;">Approve USDC then reserve your ticket</p>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <button id="approveBtn" style="
                            background-color: #FF9800;
                            color: white;
                            padding: 12px 24px;
                            font-size: 14px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            1. Approve USDC
                        </button>
                    </div>
                    <div style="flex: 1;">
                        <button id="callMethodBtn" style="
                            background-color: #4CAF50;
                            color: white;
                            padding: 12px 24px;
                            font-size: 14px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            width: 100%;
                        ">
                            2. Reserve Ticket
                        </button>
                    </div>
                </div>
            </div>

            <!-- refund & spinWheel Buttons (in one row) -->
            <div style="display: flex; gap: 15px;">
                <!-- refund Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #dc3545;">
                    <h4 style="margin-top: 0; color: #555;">üí∏ refund()</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">Get refund if not selected (Transaction required)</p>
                    <button id="refundBtn" style="
                        background-color: #dc3545;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Request Refund
                    </button>
                </div>

                <!-- spinWheel Button -->
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; border-left: 4px solid #2196F3;">
                    <h4 style="margin-top: 0; color: #555;">üé∞ spinWheel()</h4>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">Draw winners using Pyth Entropy (Admin only, Transaction required)</p>
                    <button id="spinWheelBtn" style="
                        background-color: #2196F3;
                        color: white;
                        padding: 12px 24px;
                        font-size: 14px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        width: 100%;
                    ">
                        Spin the Wheel
                    </button>
                </div>
            </div>

        </div>

        <div id="contractCallStatus" style="margin-top: 15px; padding: 15px; display: none; border-radius: 5px;"></div>
    </div>

    <!-- ==================== Configuration (Hidden - Can resume development later) ==================== -->
    <!--
    <div class="section">
        <h2>‚öôÔ∏è Configuration</h2>
        <p><strong>Description:</strong> Network and facilitator settings for x402 payment protocol. Pre-configured for Base Sepolia testnet.</p>
        
        <h3>RPC Node Information</h3>
        <ul>
            <li>Chain ID : <input type="text" id="chainId" value="84532" readonly /> <small>(Base Sepolia)</small></li>
            <li>RPC URL : <input type="text" id="rpcUrl" value="https://sepolia.base.org" readonly /></li>
        </ul>

        <h3>BuenosTickets Smart Contract Address</h3>
        <ul>
            <li>BuenosTickets Contract Address : <input type="text" id="contractAddress" value="0x55Cf458212822b33d8485969f4616FA8D9b6e1A7" readonly /></li>
        </ul>

        <h3>Facilitator Information (for x402 payment)</h3>
        <ul>
            <li>Network: <input type="text" id="facilitatorNetwork" value="base-sepolia" readonly /> <small>(baseSepolia)</small></li>
            <li>Facilitator URL: <input type="text" id="facilitatorApiEndpoint" value="http://localhost:3001/api/x402/submit" placeholder="http://localhost:3001/api/x402/submit" /></li>
            <li>Resource Wallet Address: <input type="text" id="facilitatorAddress" value="0xEfA21bF6343748f95F6949f7aAa7DF88F0eE6992" placeholder="0x..." /></li>
            <li>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="testMode" style="width: auto;" />
                    <span>Test Mode (Skip Facilitator, simulate response)</span>
                </label>
            </li>
        </ul>
        <p style="font-size: 0.9em; color: #666;">
            <strong>Note:</strong> Configure Facilitator settings to use "Pay Ticket (x402 - Gasless)" button. 
            The Facilitator will pay gas fees on your behalf.
        </p>
        <p style="font-size: 0.85em; color: #999;">
            <strong>Default Configuration:</strong><br>
            ‚Ä¢ Network: Base Sepolia (ChainID: 84532)<br>
            ‚Ä¢ Facilitator URL: http://localhost:3001 (run your own facilitator)<br>
            ‚Ä¢ Resource Wallet: Your address (receives payments)<br>
            ‚Ä¢ <strong>Test Mode:</strong> Enable to simulate x402 without real facilitator
        </p>
        <p style="font-size: 0.85em; color: #f39c12; background-color: #fff3cd; padding: 8px; border-radius: 4px;">
            ‚ö†Ô∏è <strong>Quick Start:</strong> Check "Test Mode" to try x402 flow without setting up a facilitator server.
        </p>
    </div>
    -->

    <!-- ==================== Ticket Purchase (Hidden - Can resume development later) ==================== -->
    <!--
    <div class="section">
        <h2>üé´ Ticket Purchase</h2>
        <p><strong>Description:</strong> Choose your payment method below. x402 allows gasless transactions through a Facilitator.</p>
        <p style="font-size: 0.9em; color: #666;"><strong>üí° Tip:</strong> Use "üîó Smart Contract Functions" section for individual contract function calls (Approve, Reserve).</p>
        
        <button id="payTicketBtn" style="
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        ">
            Pay Ticket (x402 - Gasless)
        </button>

        <button id="payTicketWithoutX402Btn" style="
            background-color: #2196F3;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        ">
            Direct USDC Transfer (You pay gas)
        </button>

        <div id="transactionStatus" style="margin-top: 15px; padding: 10px; display: none;"></div>
    </div>
    -->

    <script>
        // Base Sepolia Network Configuration
        const BASE_SEPOLIA_CONFIG = {
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // USDC Contract on Base Sepolia
        const USDC_CONTRACT_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e'; // Base Sepolia USDC
        
        // BuenosTickets Contract Address
        const BUENOS_TICKETS_CONTRACT_ADDRESS = '0x55Cf458212822b33d8485969f4616FA8D9b6e1A7';
        
        const RECIPIENT_ADDRESS = '0xefa21bf6343748f95f6949f7aaa7df88f0ee6992';
        const AMOUNT = '0.001'; // USDC amount
        const TICKET_PRICE = '0.01'; // Fixed ticket price in USDC (for testing)
        const APPROVAL_AMOUNT = '1000'; // USDC approval amount for Approve button

        // ERC20 ABI
        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function balanceOf(address account) view returns (uint256)',
            'function symbol() view returns (string)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        // BuenosTickets Contract ABI
        const BUENOS_TICKETS_ABI = [
            'function reserveTicket() external',
            'function ticketPrice() view returns (uint256)',
            'function endBlock() view returns (uint256)',
            'function maxTickets() view returns (uint256)',
            'function totalReserved() view returns (uint256)',
            'function getUserStatus(address user) view returns (uint8)',
            'function usdcToken() view returns (address)',
            'function refund() external',
            'function getSaleInfo() external view returns (uint256 _endBlock, uint256 _ticketPrice, uint256 _maxTickets, uint256 _totalReserved, bool _isSettled)',
            'function isSettled() view returns (bool)',
            'function spinWheel() external'
        ];

        // Helper function to switch to Base Sepolia
        async function switchToBaseSepolia() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const currentChainId = '0x' + network.chainId.toString(16);

            if (currentChainId !== BASE_SEPOLIA_CONFIG.chainId) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CONFIG.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        // ==================== Hidden Section Handlers (Can resume development later) ====================
        /*
        // Pay Ticket (x402 flow) Button Handler (Hidden)
        document.getElementById('payTicketBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Get Facilitator configuration
                const facilitatorNetwork = document.getElementById('facilitatorNetwork').value || 'base-sepolia';
                const facilitatorEndpoint = document.getElementById('facilitatorApiEndpoint').value;
                const facilitatorAddress = document.getElementById('facilitatorAddress').value;
                const testMode = document.getElementById('testMode').checked;

                if (!testMode) {
                    if (!facilitatorEndpoint || facilitatorEndpoint.trim() === '') {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = '‚ùå Please configure Facilitator API Endpoint in the Configuration section or enable Test Mode';
                        return;
                    }

                    if (!facilitatorAddress || facilitatorAddress.trim() === '') {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = '‚ùå Please configure Resource Wallet Address in the Configuration section';
                        return;
                    }
                }

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);

                statusDiv.innerHTML = `üîÑ Preparing payment data...`;

                // Get ticket price (use fixed price for now)
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                const ticketPriceInUnits = ethers.utils.parseUnits(TICKET_PRICE, decimals);

                // Create transaction data for reserveTicket()
                const txData = buenosTicketsContract.interface.encodeFunctionData('reserveTicket');

                // Prepare transaction object
                const tx = {
                    from: userAddress,
                    to: BUENOS_TICKETS_CONTRACT_ADDRESS,
                    data: txData,
                    value: '0x0',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                };

                // Get current gas price and nonce
                const gasPrice = await provider.getGasPrice();
                const nonce = await provider.getTransactionCount(userAddress, 'latest');

                tx.gasPrice = gasPrice.toHexString();
                tx.nonce = nonce;
                tx.gasLimit = ethers.utils.hexlify(100000); // Estimate

                statusDiv.innerHTML = `üîÑ Creating signed transaction...<br>Please sign in MetaMask (no gas required now)`;

                // Sign the transaction (EIP-712 typed data)
                // For x402, we create a payment request signature
                const domain = {
                    name: 'Buenos Tickets x402',
                    version: '1',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    verifyingContract: BUENOS_TICKETS_CONTRACT_ADDRESS
                };

                const types = {
                    PaymentRequest: [
                        { name: 'from', type: 'address' },
                        { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'data', type: 'bytes' },
                        { name: 'nonce', type: 'uint256' },
                        { name: 'deadline', type: 'uint256' }
                    ]
                };

                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 hour from now

                const value = {
                    from: userAddress,
                    to: BUENOS_TICKETS_CONTRACT_ADDRESS,
                    value: 0,
                    data: txData,
                    nonce: nonce,
                    deadline: deadline
                };

                // Sign typed data
                const signature = await signer._signTypedData(domain, types, value);

                // Prepare payload for facilitator
                const payload = {
                    type: 'x402-payment',
                    network: facilitatorNetwork,
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    transaction: tx,
                    signature: signature,
                    signedData: {
                        domain,
                        types,
                        value
                    },
                    payment: {
                        amount: TICKET_PRICE,
                        currency: symbol,
                        description: 'Buenos Tickets - Tango Event',
                        from: userAddress,
                        to: facilitatorAddress
                    }
                };

                let facilitatorResult;

                if (testMode) {
                    // Test mode: Simulate facilitator response
                    statusDiv.innerHTML = `üîÑ TEST MODE: Simulating facilitator response...<br>No actual transaction will be sent`;
                    
                    console.log('üß™ TEST MODE ENABLED');
                    console.log('üì¶ Payload that would be sent:', payload);
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    facilitatorResult = {
                        success: true,
                        txHash: '0x' + '0'.repeat(64), // Mock transaction hash
                        message: 'Test mode: Transaction simulated',
                        timestamp: Date.now()
                    };
                    
                    console.log('‚úÖ Simulated response:', facilitatorResult);

                } else {
                    // Real mode: Send to actual facilitator
                    statusDiv.innerHTML = `üîÑ Sending payment request to Facilitator...<br>Facilitator will broadcast the transaction`;
                    
                    console.log('üì§ Sending to facilitator:', facilitatorEndpoint);
                    console.log('üì¶ Payload:', payload);
                    
                    const facilitatorResponse = await fetch(facilitatorEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    }).catch(fetchError => {
                        console.error('‚ùå Fetch error:', fetchError);
                        throw new Error(`Cannot connect to Facilitator. Please check:\n1. Facilitator URL is correct\n2. Facilitator service is running\n3. CORS is properly configured\n\nError: ${fetchError.message}`);
                    });

                    if (!facilitatorResponse.ok) {
                        const errorText = await facilitatorResponse.text();
                        console.error('‚ùå Facilitator response error:', errorText);
                        throw new Error(`Facilitator error: ${facilitatorResponse.status} ${facilitatorResponse.statusText}\nDetails: ${errorText}`);
                    }

                    facilitatorResult = await facilitatorResponse.json();
                    console.log('‚úÖ Facilitator response:', facilitatorResult);
                }

                statusDiv.innerHTML = `üîÑ ${testMode ? 'Simulated' : 'Facilitator'} processing...<br>Transaction hash: ${facilitatorResult.txHash || 'pending'}`;

                // Wait a bit for confirmation
                await new Promise(resolve => setTimeout(resolve, 2000));

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Payment ${testMode ? 'simulated' : 'submitted'} via x402!<br>
                    ${testMode ? '<strong>‚ö†Ô∏è TEST MODE - No real transaction</strong><br>' : ''}
                    Transaction: ${facilitatorResult.txHash ? `<a href="https://sepolia.basescan.org/tx/${facilitatorResult.txHash}" target="_blank" style="color: #155724;">${facilitatorResult.txHash.substring(0, 20)}...</a>` : 'Processing'}<br>
                    ${testMode ? '' : `Facilitator: ${facilitatorAddress}<br>`}
                    Amount: ${TICKET_PRICE} ${symbol}<br>
                    <small>${testMode ? 'Test mode enabled - Check console for details' : 'Facilitator pays gas fees on your behalf'}</small>`;

            } catch (error) {
                console.error('x402 Payment error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'x402 Payment failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Signature rejected by user';
                } else if (error.message && error.message.includes('Facilitator')) {
                    errorMessage = `‚ùå Facilitator error: ${error.message}`;
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = '‚ùå Network error: Check Facilitator endpoint';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });
        */

        // Approve Button Handler
        document.getElementById('approveBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `üîÑ Getting token information...`;
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();

                // Use approval amount (1000 USDC)
                const approvalAmountInUnits = ethers.utils.parseUnits(APPROVAL_AMOUNT, decimals);

                statusDiv.innerHTML = `üîÑ Approving ${APPROVAL_AMOUNT} ${symbol} to BuenosTickets contract...<br>Please confirm in MetaMask`;

                // Approve USDC to BuenosTickets contract
                const tx = await usdcContract.approve(BUENOS_TICKETS_CONTRACT_ADDRESS, approvalAmountInUnits);
                
                statusDiv.innerHTML = `üîÑ Approval submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Approval successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Amount: ${APPROVAL_AMOUNT} ${symbol}<br>
                    Spender: BuenosTickets Contract<br>
                    <small>Multiple ticket reservations now available (Approval limit: ${APPROVAL_AMOUNT} USDC)</small>`;

            } catch (error) {
                console.error('Approval error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Approval failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Call reserveTicket() Button Handler
        document.getElementById('callMethodBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                statusDiv.innerHTML = `üîÑ Calling reserveTicket()...<br>Please confirm in MetaMask`;

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                // Call reserveTicket()
                const tx = await buenosTicketsContract.reserveTicket();
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Ticket reserved successfully!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}`;

            } catch (error) {
                console.error('reserveTicket error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else if (error.code === 'CALL_EXCEPTION' || (error.message && error.message.includes('CALL_EXCEPTION'))) {
                    errorMessage = '‚ùå BuenosTickets contract not deployed yet. Please deploy the contract first.';
                } else if (error.message && error.message.includes('already reserved')) {
                    errorMessage = '‚ùå Ticket already reserved';
                } else if (error.message && error.message.includes('Sale period has ended')) {
                    errorMessage = '‚ùå Sale period has ended';
                } else if (error.message && error.message.includes('Check approval')) {
                    errorMessage = '‚ùå Insufficient USDC approval. Please click "Approve USDC" first';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        /*
        // Pay Ticket without x402 Button Handler (Hidden)
        document.getElementById('payTicketWithoutX402Btn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                // Check if ethers.js is loaded
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                // Request account access
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `üîÑ Getting token information...`;
                
                // Get token decimals and symbol
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                
                // Convert amount to proper units
                const amountInUnits = ethers.utils.parseUnits(AMOUNT, decimals);

                statusDiv.innerHTML = `üîÑ Sending ${AMOUNT} ${symbol} to ${RECIPIENT_ADDRESS}...<br>Please confirm in MetaMask`;

                // Send USDC transaction
                const tx = await usdcContract.transfer(RECIPIENT_ADDRESS, amountInUnits);
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                // Wait for transaction to be mined
                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Transaction successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    Amount: ${AMOUNT} ${symbol}`;

            } catch (error) {
                console.error('Transaction error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else if (error.code === -32603) {
                    errorMessage = '‚ùå Insufficient USDC balance or gas (ETH)';
                } else if (error.code === 4902) {
                    errorMessage = '‚ùå Failed to add Base Sepolia network';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMessage = '‚ùå Insufficient USDC balance or ETH for gas';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });
        */

        // ==================== Smart Contract Function Handlers ====================
        
        // Helper function for status display
        function getStatusText(statusCode) {
            const statuses = ['Unreserved', 'Reserved', 'Selected', 'Refunded'];
            return statuses[statusCode] || 'Unknown';
        }

        // View My Address in Explorer Button Handler
        document.getElementById('viewMyAddressBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                // Open Base Sepolia explorer in new tab
                const explorerUrl = `https://sepolia.basescan.org/address/${userAddress}`;
                window.open(explorerUrl, '_blank');

            } catch (error) {
                console.error('View address error:', error);
                if (error.code === 4001) {
                    alert('‚ùå MetaMask connection rejected');
                } else {
                    alert(`‚ùå Error: ${error.message}`);
                }
            }
        });

        // Ìè≠Ï£Ω Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÉùÏÑ± Ìï®Ïàò
        function createFireworks() {
            const container = document.createElement('div');
            container.className = 'fireworks-container';
            document.body.appendChild(container);
            
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500'];
            const fireworkCount = 50;
            
            for (let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    const centerX = Math.random() * window.innerWidth;
                    const centerY = Math.random() * window.innerHeight * 0.7;
                    
                    for (let j = 0; j < 30; j++) {
                        const firework = document.createElement('div');
                        firework.className = 'firework';
                        firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        firework.style.left = centerX + 'px';
                        firework.style.top = centerY + 'px';
                        
                        const angle = (Math.PI * 2 * j) / 30;
                        const velocity = 50 + Math.random() * 100;
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;
                        
                        firework.style.setProperty('--tx', tx + 'px');
                        firework.style.setProperty('--ty', ty + 'px');
                        
                        container.appendChild(firework);
                    }
                }, i * 60);
            }
            
            setTimeout(() => {
                container.remove();
            }, 3000);
        }

        // getSaleInfo Button Handler
        document.getElementById('getSaleInfoBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            const successBanner = document.getElementById('successBanner');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to contract...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract (read-only)
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                statusDiv.innerHTML = 'üîÑ Calling getSaleInfo()...';

                const saleInfo = await contract.getSaleInfo();
                
                // Check Is Settled status then check user status
                if (saleInfo._isSettled) {
                    // Query getUserStatus in background (not displayed in result area)
                    const userStatus = await contract.getUserStatus(userAddress);
                    
                    // Show fireworks and congratulations only when Status = 2 (Selected, Winner)
                    if (userStatus === 2) {
                        successBanner.style.display = 'block';
                        successBanner.className = 'success-banner';
                        successBanner.innerHTML = 'üéâ Congratulations! You Won the Ticket! üéâ';
                        
                        // Execute fireworks animation (banner stays, animation removed after 3 seconds)
                        createFireworks();
                    } else {
                        // Hide banner if not selected
                        successBanner.style.display = 'none';
                    }
                } else {
                    // Hide banner if not settled
                    successBanner.style.display = 'none';
                }
                
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Sale info retrieved successfully!<br><br>
                    <strong>üìä Sale Information:</strong><br>
                    ‚Ä¢ <strong>End Block:</strong> ${saleInfo._endBlock.toString()}<br>
                    ‚Ä¢ <strong>Ticket Price:</strong> ${ethers.utils.formatUnits(saleInfo._ticketPrice, 6)} USDC<br>
                    ‚Ä¢ <strong>Max Tickets:</strong> ${saleInfo._maxTickets.toString()}<br>
                    ‚Ä¢ <strong>Total Reserved:</strong> ${saleInfo._totalReserved.toString()}<br>
                    ‚Ä¢ <strong>Is Settled:</strong> ${saleInfo._isSettled ? 'Yes ‚úÖ' : 'No ‚ùå'}`;

            } catch (error) {
                console.error('getSaleInfo error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                
                // Hide banner on error
                successBanner.style.display = 'none';
            }
        });

        // getUserStatus Button Handler
        document.getElementById('getUserStatusBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract (read-only)
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                statusDiv.innerHTML = `üîÑ Calling getUserStatus()...`;

                const status = await contract.getUserStatus(userAddress);
                const statusText = getStatusText(status);
                
                // Status color coding
                let statusEmoji = '‚ùì';
                let statusColor = '#666';
                if (status === 0) { statusEmoji = '‚ö™'; statusColor = '#6c757d'; } // Unreserved
                else if (status === 1) { statusEmoji = 'üü°'; statusColor = '#ffc107'; } // Reserved
                else if (status === 2) { statusEmoji = 'üü¢'; statusColor = '#28a745'; } // Selected
                else if (status === 3) { statusEmoji = 'üî¥'; statusColor = '#dc3545'; } // Refunded

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Status retrieved successfully!<br><br>
                    <strong>üë§ My Status:</strong><br>
                    ‚Ä¢ <strong>Address:</strong> ${userAddress}<br>
                    ‚Ä¢ <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusEmoji} ${statusText} (${status})</span><br><br>
                    <small>
                        <strong>Status Description:</strong><br>
                        0 = Unreserved (Not reserved) ‚ö™<br>
                        1 = Reserved (Reserved, waiting for draw) üü°<br>
                        2 = Selected (Winner!) üü¢<br>
                        3 = Refunded (Refunded) üî¥
                    </small>`;

            } catch (error) {
                console.error('getUserStatus error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });

        // refund Button Handler
        document.getElementById('refundBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                // Pre-check 1: Check if settled
                statusDiv.innerHTML = 'üîÑ Checking contract status...';
                const isSettled = await contract.isSettled();
                
                if (!isSettled) {
                    statusDiv.style.backgroundColor = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.innerHTML = `‚ö†Ô∏è <strong>Refund Not Available</strong><br><br>
                        The draw has not been completed yet.<br>
                        Refund is available after the draw.<br><br>
                        <small>üí° <strong>Tip:</strong> Check current status with "Get Sale Info" button.<br>
                        You can request a refund when Is Settled changes to "Yes".</small>`;
                    return;
                }

                // Pre-check 2: Check user's reservation status
                statusDiv.innerHTML = 'üîÑ Checking user reservation status...';
                const userStatus = await contract.getUserStatus(userAddress);
                
                if (userStatus === 0) {
                    statusDiv.style.backgroundColor = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.innerHTML = `‚ö†Ô∏è <strong>Refund Not Available</strong><br><br>
                        No reservation found.<br>
                        You need to reserve a ticket first to get a refund.`;
                    return;
                }

                if (userStatus === 2) {
                    statusDiv.style.backgroundColor = '#d1ecf1';
                    statusDiv.style.color = '#0c5460';
                    statusDiv.innerHTML = `üéâ <strong>Congratulations!</strong><br><br>
                        You won the ticket!<br>
                        Winners cannot receive refunds.<br><br>
                        <small>üí° Your ticket purchase is confirmed.</small>`;
                    return;
                }

                if (userStatus === 3) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `‚úÖ Already refunded.<br><br>
                        Duplicate refunds are not allowed.`;
                    return;
                }

                // Pre-checks passed - MetaMask popup will appear
                statusDiv.innerHTML = 'üîÑ Calling refund()...<br><strong>Please confirm in MetaMask</strong>';

                // Call refund()
                const tx = await contract.refund();
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Refund successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    <small>Refund completed. USDC has been returned to your wallet.</small>`;

            } catch (error) {
                console.error('refund error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Refund failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå User rejected the transaction';
                } else if (error.message && error.message.includes('No active reservation')) {
                    errorMessage = '‚ùå No reservation found';
                } else if (error.message && error.message.includes('User was either selected or already refunded')) {
                    errorMessage = '‚ùå Already won or refunded';
                } else if (error.message && error.message.includes('Sale must be settled first')) {
                    errorMessage = '‚ùå Draw not completed yet. Refund available after draw.';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // spinWheel Button Handler
        document.getElementById('spinWheelBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('contractCallStatus');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to BuenosTickets contract
                const contract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                statusDiv.innerHTML = 'üîÑ Calling spinWheel()...<br><strong>Please confirm in MetaMask</strong><br><br><small>‚ö†Ô∏è Admin permission required</small>';

                // Call spinWheel()
                const tx = await contract.spinWheel();
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...<br><small>Drawing winners with Pyth Entropy...</small>`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Draw completed!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    <small>üé∞ Random draw using Pyth Entropy completed.<br>
                    Winners have been selected and losers can request refunds.</small>`;

            } catch (error) {
                console.error('spinWheel error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Draw failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå User rejected the transaction';
                } else if (error.message && error.message.includes('Only admin')) {
                    errorMessage = '‚ùå Admin permission required';
                } else if (error.message && error.message.includes('Sale is still active')) {
                    errorMessage = '‚ùå Sale period has not ended yet';
                } else if (error.message && error.message.includes('already settled')) {
                    errorMessage = '‚ùå Draw already completed';
                } else if (error.message && error.message.includes('Invalid Pyth Entropy')) {
                    errorMessage = '‚ùå Pyth Entropy callback not executed yet. Please wait after running settleSale().';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });
    </script>

</body>
</html>
