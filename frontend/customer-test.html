<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tango Ticket Sales</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #f0f0f0;
            color: #666;
        }
        #transactionStatus {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <h1>Buenos Tickets - Customer (Pyth, x402 and Hardhat)</h1>

    <!-- ==================== Section 1: Ticket Purchase ==================== -->
    <div class="section">
        <h2>üé´ Ticket Purchase</h2>
        <p><strong>Description:</strong> Choose your payment method below. x402 allows gasless transactions through a Facilitator.</p>
        
        <button id="payTicketBtn" style="
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        ">
            Pay Ticket (x402 - Gasless)
        </button>

        <button id="payTicketWithoutX402Btn" style="
            background-color: #2196F3;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        ">
            Direct USDC Transfer (You pay gas)
        </button>

        <div style="margin-top: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
            <p style="margin: 0 0 10px 0; font-size: 0.9em;"><strong>Alternative: Direct Contract Interaction</strong> (2-step process)</p>
            <div style="display: flex; gap: 10px;">
                <button id="approveBtn" style="
                    background-color: #FF9800;
                    color: white;
                    padding: 15px 32px;
                    text-align: center;
                    font-size: 16px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    flex: 1;
                ">
                    1. Approve USDC
                </button>

                <button id="callMethodBtn" style="
                    background-color: #9C27B0;
                    color: white;
                    padding: 15px 32px;
                    text-align: center;
                    font-size: 16px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    flex: 1;
                ">
                    2. Reserve Ticket
                </button>
            </div>
        </div>

        <button id="getSaleInfoBtn" style="
            background-color: #607D8B;
            color: white;
            padding: 15px 32px;
            text-align: center;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        ">
            üìä Get Sale Info (getSaleInfo)
        </button>

        <div id="transactionStatus" style="margin-top: 15px; padding: 10px; display: none;"></div>
    </div>

    <!-- ==================== Section 2: Configuration ==================== -->
    <div class="section">
        <h2>‚öôÔ∏è Configuration</h2>
        <p><strong>Description:</strong> Network and facilitator settings for x402 payment protocol. Pre-configured for Base Sepolia testnet.</p>
        
        <h3>RPC Node Information</h3>
        <ul>
            <li>Chain ID : <input type="text" id="chainId" value="84532" readonly /> <small>(Base Sepolia)</small></li>
            <li>RPC URL : <input type="text" id="rpcUrl" value="https://sepolia.base.org" readonly /></li>
        </ul>

        <h3>BuenosTickets Smart Contract Address</h3>
        <ul>
            <li>BuenosTickets Contract Address : <input type="text" id="contractAddress" value="0x55Cf458212822b33d8485969f4616FA8D9b6e1A7" readonly /></li>
        </ul>

        <h3>Facilitator Information (for x402 payment)</h3>
        <ul>
            <li>Network: <input type="text" id="facilitatorNetwork" value="base-sepolia" readonly /> <small>(baseSepolia)</small></li>
            <li>Facilitator URL: <input type="text" id="facilitatorApiEndpoint" value="http://localhost:3001/api/x402/submit" placeholder="http://localhost:3001/api/x402/submit" /></li>
            <li>Resource Wallet Address: <input type="text" id="facilitatorAddress" value="0xEfA21bF6343748f95F6949f7aAa7DF88F0eE6992" placeholder="0x..." /></li>
            <li>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="testMode" style="width: auto;" />
                    <span>Test Mode (Skip Facilitator, simulate response)</span>
                </label>
            </li>
        </ul>
        <p style="font-size: 0.9em; color: #666;">
            <strong>Note:</strong> Configure Facilitator settings to use "Pay Ticket (x402 - Gasless)" button. 
            The Facilitator will pay gas fees on your behalf.
        </p>
        <p style="font-size: 0.85em; color: #999;">
            <strong>Default Configuration:</strong><br>
            ‚Ä¢ Network: Base Sepolia (ChainID: 84532)<br>
            ‚Ä¢ Facilitator URL: http://localhost:3001 (run your own facilitator)<br>
            ‚Ä¢ Resource Wallet: Your address (receives payments)<br>
            ‚Ä¢ <strong>Test Mode:</strong> Enable to simulate x402 without real facilitator
        </p>
        <p style="font-size: 0.85em; color: #f39c12; background-color: #fff3cd; padding: 8px; border-radius: 4px;">
            ‚ö†Ô∏è <strong>Quick Start:</strong> Check "Test Mode" to try x402 flow without setting up a facilitator server.
        </p>
    </div>

    <!-- ==================== Section 3: Event Information ==================== -->
    <div class="section">
        <h2>üé≠ Event Information</h2>
        <p><strong>Description:</strong> Ïù¥Î≤§Ìä∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ÏûÖÎãàÎã§.</p>
        
        <div>
            <h3>Poster</h3>
            
            <p><img src="assets/img/tango-poster-generated-gemini-ai.png" alt="Tango Event Poster" style="max-width: 100%;" /></p>
        </div>
        <div>
            <h3>Title</h3>
            <p id="eventTitle">Buenos Aires ÌÉ±Í≥† Í≥µÏó∞</p>

            <h3>Description</h3>
            <p id="eventDescription">ÏïÑÎ•¥Ìó®Ìã∞ÎÇòÏùò Ï†ïÏó¥Ï†ÅÏù∏ ÌÉ±Í≥† Í≥µÏó∞ÏùÑ Í≤ΩÌóòÌï¥Î≥¥ÏÑ∏Ïöî. ÏÑ∏Í≥ÑÏ†ÅÏù∏ ÌÉ±Í≥† ÎåÑÏÑúÎì§Ïù¥ ÏÑ†ÏÇ¨ÌïòÎäî ÌôòÏÉÅÏ†ÅÏù∏ Î¨¥ÎåÄ!</p>

            <h3>Ticket Price</h3>
            <p id="ticketPrice">0.01 USDC</p>

            <h3>Deadline</h3>
            <p id="eventDeadline">12 Dec 2025</p>
        </div>
    </div>

    <script>
        // Base Sepolia Network Configuration
        const BASE_SEPOLIA_CONFIG = {
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // USDC Contract on Base Sepolia
        const USDC_CONTRACT_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e'; // Base Sepolia USDC
        
        // BuenosTickets Contract Address
        const BUENOS_TICKETS_CONTRACT_ADDRESS = '0x55Cf458212822b33d8485969f4616FA8D9b6e1A7';
        
        const RECIPIENT_ADDRESS = '0xefa21bf6343748f95f6949f7aaa7df88f0ee6992';
        const AMOUNT = '0.001'; // USDC amount
        const TICKET_PRICE = '0.01'; // Fixed ticket price in USDC (for testing)

        // ERC20 ABI
        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function balanceOf(address account) view returns (uint256)',
            'function symbol() view returns (string)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        // BuenosTickets Contract ABI
        const BUENOS_TICKETS_ABI = [
            'function reserveTicket() external',
            'function ticketPrice() view returns (uint256)',
            'function endBlock() view returns (uint256)',
            'function maxTickets() view returns (uint256)',
            'function totalReserved() view returns (uint256)',
            'function getUserStatus(address user) view returns (uint8)',
            'function usdcToken() view returns (address)',
            'function getSaleInfo() view returns (uint256 _endBlock, uint256 _ticketPrice, uint256 _maxTickets, uint256 _totalReserved, bool _isSettled)'
        ];

        // Helper function to switch to Base Sepolia
        async function switchToBaseSepolia() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const currentChainId = '0x' + network.chainId.toString(16);

            if (currentChainId !== BASE_SEPOLIA_CONFIG.chainId) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CONFIG.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        // Pay Ticket (x402 flow) Button Handler
        document.getElementById('payTicketBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Get Facilitator configuration
                const facilitatorNetwork = document.getElementById('facilitatorNetwork').value || 'base-sepolia';
                const facilitatorEndpoint = document.getElementById('facilitatorApiEndpoint').value;
                const facilitatorAddress = document.getElementById('facilitatorAddress').value;
                const testMode = document.getElementById('testMode').checked;

                if (!testMode) {
                    if (!facilitatorEndpoint || facilitatorEndpoint.trim() === '') {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = '‚ùå Please configure Facilitator API Endpoint in the Configuration section or enable Test Mode';
                        return;
                    }

                    if (!facilitatorAddress || facilitatorAddress.trim() === '') {
                        statusDiv.style.backgroundColor = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = '‚ùå Please configure Resource Wallet Address in the Configuration section';
                        return;
                    }
                }

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    provider
                );

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);

                statusDiv.innerHTML = `üîÑ Preparing payment data...`;

                // Get ticket price (use fixed price for now)
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                const ticketPriceInUnits = ethers.utils.parseUnits(TICKET_PRICE, decimals);

                // Create transaction data for reserveTicket()
                const txData = buenosTicketsContract.interface.encodeFunctionData('reserveTicket');

                // Prepare transaction object
                const tx = {
                    from: userAddress,
                    to: BUENOS_TICKETS_CONTRACT_ADDRESS,
                    data: txData,
                    value: '0x0',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                };

                // Get current gas price and nonce
                const gasPrice = await provider.getGasPrice();
                const nonce = await provider.getTransactionCount(userAddress, 'latest');

                tx.gasPrice = gasPrice.toHexString();
                tx.nonce = nonce;
                tx.gasLimit = ethers.utils.hexlify(100000); // Estimate

                statusDiv.innerHTML = `üîÑ Creating signed transaction...<br>Please sign in MetaMask (no gas required now)`;

                // Sign the transaction (EIP-712 typed data)
                // For x402, we create a payment request signature
                const domain = {
                    name: 'Buenos Tickets x402',
                    version: '1',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    verifyingContract: BUENOS_TICKETS_CONTRACT_ADDRESS
                };

                const types = {
                    PaymentRequest: [
                        { name: 'from', type: 'address' },
                        { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'data', type: 'bytes' },
                        { name: 'nonce', type: 'uint256' },
                        { name: 'deadline', type: 'uint256' }
                    ]
                };

                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 hour from now

                const value = {
                    from: userAddress,
                    to: BUENOS_TICKETS_CONTRACT_ADDRESS,
                    value: 0,
                    data: txData,
                    nonce: nonce,
                    deadline: deadline
                };

                // Sign typed data
                const signature = await signer._signTypedData(domain, types, value);

                // Prepare payload for facilitator
                const payload = {
                    type: 'x402-payment',
                    network: facilitatorNetwork,
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    transaction: tx,
                    signature: signature,
                    signedData: {
                        domain,
                        types,
                        value
                    },
                    payment: {
                        amount: TICKET_PRICE,
                        currency: symbol,
                        description: 'Buenos Tickets - Tango Event',
                        from: userAddress,
                        to: facilitatorAddress
                    }
                };

                let facilitatorResult;

                if (testMode) {
                    // Test mode: Simulate facilitator response
                    statusDiv.innerHTML = `üîÑ TEST MODE: Simulating facilitator response...<br>No actual transaction will be sent`;
                    
                    console.log('üß™ TEST MODE ENABLED');
                    console.log('üì¶ Payload that would be sent:', payload);
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    facilitatorResult = {
                        success: true,
                        txHash: '0x' + '0'.repeat(64), // Mock transaction hash
                        message: 'Test mode: Transaction simulated',
                        timestamp: Date.now()
                    };
                    
                    console.log('‚úÖ Simulated response:', facilitatorResult);

                } else {
                    // Real mode: Send to actual facilitator
                    statusDiv.innerHTML = `üîÑ Sending payment request to Facilitator...<br>Facilitator will broadcast the transaction`;
                    
                    console.log('üì§ Sending to facilitator:', facilitatorEndpoint);
                    console.log('üì¶ Payload:', payload);
                    
                    const facilitatorResponse = await fetch(facilitatorEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    }).catch(fetchError => {
                        console.error('‚ùå Fetch error:', fetchError);
                        throw new Error(`Cannot connect to Facilitator. Please check:\n1. Facilitator URL is correct\n2. Facilitator service is running\n3. CORS is properly configured\n\nError: ${fetchError.message}`);
                    });

                    if (!facilitatorResponse.ok) {
                        const errorText = await facilitatorResponse.text();
                        console.error('‚ùå Facilitator response error:', errorText);
                        throw new Error(`Facilitator error: ${facilitatorResponse.status} ${facilitatorResponse.statusText}\nDetails: ${errorText}`);
                    }

                    facilitatorResult = await facilitatorResponse.json();
                    console.log('‚úÖ Facilitator response:', facilitatorResult);
                }

                statusDiv.innerHTML = `üîÑ ${testMode ? 'Simulated' : 'Facilitator'} processing...<br>Transaction hash: ${facilitatorResult.txHash || 'pending'}`;

                // Wait a bit for confirmation
                await new Promise(resolve => setTimeout(resolve, 2000));

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Payment ${testMode ? 'simulated' : 'submitted'} via x402!<br>
                    ${testMode ? '<strong>‚ö†Ô∏è TEST MODE - No real transaction</strong><br>' : ''}
                    Transaction: ${facilitatorResult.txHash ? `<a href="https://sepolia.basescan.org/tx/${facilitatorResult.txHash}" target="_blank" style="color: #155724;">${facilitatorResult.txHash.substring(0, 20)}...</a>` : 'Processing'}<br>
                    ${testMode ? '' : `Facilitator: ${facilitatorAddress}<br>`}
                    Amount: ${TICKET_PRICE} ${symbol}<br>
                    <small>${testMode ? 'Test mode enabled - Check console for details' : 'Facilitator pays gas fees on your behalf'}</small>`;

            } catch (error) {
                console.error('x402 Payment error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'x402 Payment failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Signature rejected by user';
                } else if (error.message && error.message.includes('Facilitator')) {
                    errorMessage = `‚ùå Facilitator error: ${error.message}`;
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = '‚ùå Network error: Check Facilitator endpoint';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Approve Button Handler
        document.getElementById('approveBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `üîÑ Getting token information...`;
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();

                // Use fixed ticket price
                const ticketPriceInUnits = ethers.utils.parseUnits(TICKET_PRICE, decimals);

                statusDiv.innerHTML = `üîÑ Approving ${TICKET_PRICE} ${symbol} to BuenosTickets contract...<br>Please confirm in MetaMask`;

                // Approve USDC to BuenosTickets contract
                const tx = await usdcContract.approve(BUENOS_TICKETS_CONTRACT_ADDRESS, ticketPriceInUnits);
                
                statusDiv.innerHTML = `üîÑ Approval submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Approval successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Amount: ${TICKET_PRICE} ${symbol}<br>
                    Spender: BuenosTickets Contract<br>
                    <small>Note: Deploy BuenosTickets contract before calling reserveTicket()</small>`;

            } catch (error) {
                console.error('Approval error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Approval failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Call reserveTicket() Button Handler
        document.getElementById('callMethodBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                statusDiv.innerHTML = `üîÑ Calling reserveTicket()...<br>Please confirm in MetaMask`;

                // Connect to BuenosTickets contract
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS, 
                    BUENOS_TICKETS_ABI, 
                    signer
                );

                // Call reserveTicket()
                const tx = await buenosTicketsContract.reserveTicket();
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Ticket reserved successfully!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}`;

            } catch (error) {
                console.error('reserveTicket error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else if (error.code === 'CALL_EXCEPTION' || (error.message && error.message.includes('CALL_EXCEPTION'))) {
                    errorMessage = '‚ùå BuenosTickets contract not deployed yet. Please deploy the contract first.';
                } else if (error.message && error.message.includes('already reserved')) {
                    errorMessage = '‚ùå Ticket already reserved';
                } else if (error.message && error.message.includes('Sale period has ended')) {
                    errorMessage = '‚ùå Sale period has ended';
                } else if (error.message && error.message.includes('Check approval')) {
                    errorMessage = '‚ùå Insufficient USDC approval. Please click "Approve USDC" first';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Pay Ticket without x402 Button Handler
        document.getElementById('payTicketWithoutX402Btn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                // Check if ethers.js is loaded
                if (typeof ethers === 'undefined') {
                    alert('Error: ethers.js library not loaded.');
                    return;
                }

                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this feature!');
                    return;
                }

                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Connecting to MetaMask...';

                // Request account access
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                statusDiv.innerHTML = `üîÑ Connected: ${userAddress}<br>Checking network...`;

                await switchToBaseSepolia();

                // Connect to USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                
                statusDiv.innerHTML = `üîÑ Getting token information...`;
                
                // Get token decimals and symbol
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                
                // Convert amount to proper units
                const amountInUnits = ethers.utils.parseUnits(AMOUNT, decimals);

                statusDiv.innerHTML = `üîÑ Sending ${AMOUNT} ${symbol} to ${RECIPIENT_ADDRESS}...<br>Please confirm in MetaMask`;

                // Send USDC transaction
                const tx = await usdcContract.transfer(RECIPIENT_ADDRESS, amountInUnits);
                
                statusDiv.innerHTML = `üîÑ Transaction submitted!<br>Hash: ${tx.hash}<br>Waiting for confirmation...`;

                // Wait for transaction to be mined
                const receipt = await tx.wait();

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Transaction successful!<br>
                    Hash: <a href="https://sepolia.basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724;">${receipt.transactionHash.substring(0, 20)}...</a><br>
                    Block: ${receipt.blockNumber}<br>
                    Amount: ${AMOUNT} ${symbol}`;

            } catch (error) {
                console.error('Transaction error:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                
                let errorMessage = 'Transaction failed!';
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user';
                } else if (error.code === -32603) {
                    errorMessage = '‚ùå Insufficient USDC balance or gas (ETH)';
                } else if (error.code === 4902) {
                    errorMessage = '‚ùå Failed to add Base Sepolia network';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMessage = '‚ùå Insufficient USDC balance or ETH for gas';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                statusDiv.innerHTML = errorMessage;
            }
        });

        // Get Sale Info Button Handler
        document.getElementById('getSaleInfoBtn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('transactionStatus');
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'üîÑ Querying contract...';

                // Use public RPC - no wallet connection needed for read-only calls
                const provider = new ethers.providers.JsonRpcProvider('https://sepolia.base.org');
                
                // Connect to BuenosTickets contract (read-only)
                const buenosTicketsContract = new ethers.Contract(
                    BUENOS_TICKETS_CONTRACT_ADDRESS,
                    BUENOS_TICKETS_ABI,
                    provider
                );

                statusDiv.innerHTML = 'üîÑ Calling getSaleInfo()...';

                // Call getSaleInfo()
                const saleInfo = await buenosTicketsContract.getSaleInfo();
                
                // Destructure the returned values
                const [endBlock, ticketPrice, maxTickets, totalReserved, isSettled] = saleInfo;

                // Get USDC decimals for proper price display
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, provider);
                const decimals = await usdcContract.decimals();

                // Format ticket price
                const formattedPrice = ethers.utils.formatUnits(ticketPrice, decimals);

                // Calculate current block number
                const currentBlock = await provider.getBlockNumber();
                const blocksRemaining = endBlock.toNumber() > currentBlock ? endBlock.toNumber() - currentBlock : 0;
                const estimatedMinutes = Math.floor(blocksRemaining * 2 / 60);

                // Build status message
                let statusMessage = '';
                if (blocksRemaining > 0) {
                    statusMessage = `<span style="color: green;">ÌåêÎß§ ÏßÑÌñâÏ§ë (${blocksRemaining} Î∏îÎ°ù ÎÇ®Ïùå, ÏïΩ ${estimatedMinutes}Î∂Ñ)</span>`;
                } else {
                    statusMessage = '<span style="color: red;">ÌåêÎß§ Ï¢ÖÎ£åÎê®</span>';
                }

                if (isSettled) {
                    statusMessage += ' <span style="color: blue;">- Ï†ïÏÇ∞ ÏôÑÎ£å</span>';
                }

                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `
                    ‚úÖ <strong>Sale Info Retrieved Successfully</strong><br><br>
                    <div style="text-align: left;">
                        <strong>üìã Contract Address:</strong><br>
                        <code style="font-size: 0.85em;">${BUENOS_TICKETS_CONTRACT_ADDRESS}</code><br><br>
                        
                        <strong>üéüÔ∏è Ticket Price:</strong> ${formattedPrice} USDC<br>
                        <strong>üì¶ Max Tickets:</strong> ${maxTickets.toString()}<br>
                        <strong>üé´ Reserved Tickets:</strong> ${totalReserved.toString()}<br>
                        <strong>üèÅ End Block:</strong> #${endBlock.toString()}<br>
                        <strong>üî¢ Current Block:</strong> #${currentBlock}<br>
                        <strong>üìä Status:</strong> ${statusMessage}<br>
                        <strong>‚úÖ Settled:</strong> ${isSettled ? 'Yes' : 'No'}
                    </div>
                `;

                console.log('‚úÖ Contract info loaded:', {
                    endBlock: endBlock.toString(),
                    ticketPrice: formattedPrice,
                    maxTickets: maxTickets.toString(),
                    totalReserved: totalReserved.toString(),
                    isSettled: isSettled,
                    currentBlock: currentBlock,
                    blocksRemaining: blocksRemaining
                });

            } catch (error) {
                console.error('‚ùå Failed to load contract info:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });
    </script>

</body>
</html>
