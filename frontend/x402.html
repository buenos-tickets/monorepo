<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x402 Payment Demo - Pay Now</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        
        .info-box h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .info-box p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .config-section {
            margin-bottom: 25px;
        }
        
        .config-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item label {
            display: block;
            color: #555;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .config-item input[type="text"],
        .config-item input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e4e8;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .config-item input[type="text"]:focus,
        .config-item input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .config-item input[readonly] {
            background-color: #f6f8fa;
            color: #666;
            cursor: not-allowed;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .checkbox-wrapper:hover {
            background: #e9ecef;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-wrapper label {
            cursor: pointer;
            color: #555;
            font-size: 14px;
            margin: 0;
        }
        
        #payNowBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        #payNowBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        #payNowBtn:active {
            transform: translateY(0);
        }
        
        #payNowBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #statusDiv {
            margin-top: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .status-icon {
            font-size: 20px;
            margin-right: 8px;
        }
        
        a {
            color: inherit;
            text-decoration: underline;
            font-weight: 600;
        }
        
        .small-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .warning-box strong {
            color: #856404;
        }
        
        .warning-box p {
            color: #856404;
            font-size: 14px;
            margin: 8px 0 0 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ x402 Payment Demo</h1>
        <p class="subtitle">
            x402 í”„ë¡œí† ì½œì„ ì‚¬ìš©í•œ ê°€ìŠ¤ë¦¬ìŠ¤ ê²°ì œ ë°ëª¨ì…ë‹ˆë‹¤.<br>
            ì‚¬ìš©ìëŠ” ETH ê°€ìŠ¤ë¹„ ì—†ì´ USDCë§Œìœ¼ë¡œ ê²°ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        
        <div class="info-box">
            <h3>ğŸ”’ x402 í”„ë¡œí† ì½œì´ë€?</h3>
            <p>
                x402ëŠ” HTTP 402 Payment Requiredë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ê²°ì œ í”„ë¡œí† ì½œì…ë‹ˆë‹¤. 
                ì‚¬ìš©ìê°€ íŠ¸ëœì­ì…˜ì— ì„œëª…í•˜ë©´, í¼ì‹¤ë¦¬í…Œì´í„°ê°€ ê°€ìŠ¤ë¹„ë¥¼ ëŒ€ì‹  ì§€ë¶ˆí•˜ê³  
                ë„¤íŠ¸ì›Œí¬ì— íŠ¸ëœì­ì…˜ì„ ì „ì†¡í•©ë‹ˆë‹¤.
            </p>
        </div>
        
        <!-- Configuration Section -->
        <div class="config-section">
            <h3>âš™ï¸ ì„¤ì •</h3>
            
            <div class="config-item">
                <label>ë„¤íŠ¸ì›Œí¬</label>
                <input type="text" id="networkName" value="Base Sepolia" readonly />
            </div>
            
            <div class="config-item">
                <label>Chain ID</label>
                <input type="text" id="chainId" value="84532" readonly />
            </div>
            
            <div class="config-item">
                <label>USDC ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ (Base Sepolia)</label>
                <input type="text" id="usdcAddress" value="0x036CbD53842c5426634e7929541eC2318f3dCF7e" readonly />
            </div>
            
            <div class="config-item">
                <label>í¼ì‹¤ë¦¬í…Œì´í„° URL</label>
                <input type="text" id="facilitatorUrl" value="http://localhost:3001/api/x402/submit" 
                       placeholder="http://localhost:3001/api/x402/submit" />
                <p class="small-text">CDP Facilitator ì„œë²„ ì£¼ì†Œ (ê¸°ë³¸: http://localhost:3001/api/x402/submit)</p>
            </div>
            
            <div class="config-item">
                <label>ê²°ì œ ìˆ˜ì‹  ì£¼ì†Œ (Resource Wallet)</label>
                <input type="text" id="payToAddress" value="0xEfA21bF6343748f95F6949f7aAa7DF88F0eE6992" 
                       placeholder="0x..." />
                <p class="small-text">ê²°ì œë¥¼ ë°›ì„ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            
            <div class="config-item">
                <label>ê²°ì œ ê¸ˆì•¡ (USDC)</label>
                <input type="number" id="paymentAmount" value="0.01" step="0.01" min="0.01" />
                <p class="small-text">ê²°ì œí•  USDC ê¸ˆì•¡ (ì˜ˆ: 0.01 USDC)</p>
            </div>
            
            <div class="config-item">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="testMode" />
                    <label for="testMode">í…ŒìŠ¤íŠ¸ ëª¨ë“œ (í¼ì‹¤ë¦¬í…Œì´í„° ì—†ì´ ì‹œë®¬ë ˆì´ì…˜)</label>
                </div>
            </div>
        </div>
        
        <button id="payNowBtn">ğŸ’° Pay Now</button>
        
        <div id="statusDiv"></div>
        
        <div class="warning-box">
            <strong>âš ï¸ ì‚¬ìš© ë°©ë²•</strong>
            <p>â€¢ CDP Facilitator ì„œë²„ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”: <code>node cdp-facilitator.js</code></p>
            <p>â€¢ ì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ "Pay Now" ë²„íŠ¼ìœ¼ë¡œ ê²°ì œí•˜ì„¸ìš”</p>
            <p>â€¢ MetaMask ì§€ê°‘ê³¼ Base Sepolia USDCê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
        </div>
    </div>

    <script>
        // Base Sepolia Configuration
        const BASE_SEPOLIA_CONFIG = {
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        // USDC Contract Address on Base Sepolia
        const USDC_CONTRACT_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e';
        
        // ERC20 ABI
        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function decimals() view returns (uint8)',
            'function balanceOf(address account) view returns (uint256)',
            'function symbol() view returns (string)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        /**
         * Switch to Base Sepolia network
         */
        async function switchToBaseSepolia() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();
            const currentChainId = '0x' + network.chainId.toString(16);

            if (currentChainId !== BASE_SEPOLIA_CONFIG.chainId) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_SEPOLIA_CONFIG.chainId }],
                    });
                } catch (switchError) {
                    // Chain not added, add it
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [BASE_SEPOLIA_CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        /**
         * Update status display
         */
        function updateStatus(message, type = 'pending') {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.style.display = 'block';
            statusDiv.className = `status-${type}`;
            
            let icon = 'ğŸ”„';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';
            
            statusDiv.innerHTML = `<span class="status-icon">${icon}</span>${message}`;
        }

        /**
         * Main Pay Now handler using x402 protocol
         */
        document.getElementById('payNowBtn').addEventListener('click', async () => {
            const payNowBtn = document.getElementById('payNowBtn');
            
            try {
                // Check dependencies
                if (typeof ethers === 'undefined') {
                    alert('ì˜¤ë¥˜: ethers.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!');
                    return;
                }

                // Disable button
                payNowBtn.disabled = true;
                updateStatus('MetaMask ì—°ê²° ì¤‘...', 'pending');

                // Connect to wallet
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                const signer = provider.getSigner();
                const userAddress = await signer.getAddress();

                updateStatus(`âœ… ì—°ê²°ë¨: ${userAddress.substring(0, 10)}...<br>ë„¤íŠ¸ì›Œí¬ í™•ì¸ ì¤‘...`, 'pending');

                // Switch to Base Sepolia
                await switchToBaseSepolia();

                // Get configuration
                const facilitatorUrl = document.getElementById('facilitatorUrl').value.trim();
                const payToAddress = document.getElementById('payToAddress').value.trim();
                const paymentAmount = document.getElementById('paymentAmount').value;
                const testMode = document.getElementById('testMode').checked;

                // Validate configuration
                if (!testMode) {
                    if (!facilitatorUrl) {
                        updateStatus('âŒ í¼ì‹¤ë¦¬í…Œì´í„° URLì„ ì…ë ¥í•˜ê±°ë‚˜ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ì„¸ìš”', 'error');
                        payNowBtn.disabled = false;
                        return;
                    }
                    if (!payToAddress || !payToAddress.startsWith('0x')) {
                        updateStatus('âŒ ì˜¬ë°”ë¥¸ ê²°ì œ ìˆ˜ì‹  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                        payNowBtn.disabled = false;
                        return;
                    }
                }

                // Get USDC contract info
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                const decimals = await usdcContract.decimals();
                const symbol = await usdcContract.symbol();
                const balance = await usdcContract.balanceOf(userAddress);

                updateStatus(`ğŸ’³ ì”ì•¡: ${ethers.utils.formatUnits(balance, decimals)} ${symbol}<br>ê²°ì œ ì¤€ë¹„ ì¤‘...`, 'pending');

                // Parse payment amount
                const amountInUnits = ethers.utils.parseUnits(paymentAmount, decimals);

                // Check balance
                if (balance.lt(amountInUnits)) {
                    updateStatus(`âŒ ì”ì•¡ ë¶€ì¡±: ${ethers.utils.formatUnits(balance, decimals)} ${symbol}`, 'error');
                    payNowBtn.disabled = false;
                    return;
                }

                // Prepare transfer transaction data
                const txData = usdcContract.interface.encodeFunctionData('transfer', [
                    payToAddress,
                    amountInUnits
                ]);

                // Get nonce and gas price
                const nonce = await provider.getTransactionCount(userAddress, 'latest');
                const gasPrice = await provider.getGasPrice();

                // Prepare transaction object
                const tx = {
                    from: userAddress,
                    to: USDC_CONTRACT_ADDRESS,
                    data: txData,
                    value: '0x0',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    gasPrice: gasPrice.toHexString(),
                    gasLimit: ethers.utils.hexlify(100000),
                    nonce: nonce
                };

                updateStatus('ğŸ“ ì„œëª… ìš”ì²­ ì¤‘...<br>MetaMaskì—ì„œ ì„œëª…í•´ì£¼ì„¸ìš” (ê°€ìŠ¤ë¹„ ì—†ìŒ)', 'pending');

                // Create EIP-712 typed data for x402
                const domain = {
                    name: 'x402 Payment Protocol',
                    version: '1',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    verifyingContract: USDC_CONTRACT_ADDRESS
                };

                const types = {
                    PaymentRequest: [
                        { name: 'from', type: 'address' },
                        { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'data', type: 'bytes' },
                        { name: 'nonce', type: 'uint256' },
                        { name: 'deadline', type: 'uint256' }
                    ]
                };

                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 hour from now

                const value = {
                    from: userAddress,
                    to: USDC_CONTRACT_ADDRESS,
                    value: 0,
                    data: txData,
                    nonce: nonce,
                    deadline: deadline
                };

                // Sign typed data (EIP-712)
                const signature = await signer._signTypedData(domain, types, value);

                // Prepare payload for facilitator
                const payload = {
                    type: 'x402-payment',
                    network: 'base-sepolia',
                    chainId: parseInt(BASE_SEPOLIA_CONFIG.chainId, 16),
                    transaction: tx,
                    signature: signature,
                    signedData: {
                        domain,
                        types,
                        value
                    },
                    payment: {
                        amount: paymentAmount,
                        currency: symbol,
                        description: 'x402 Payment Demo',
                        from: userAddress,
                        to: payToAddress
                    }
                };

                console.log('ğŸ“¦ x402 Payload:', payload);

                let facilitatorResult;

                if (testMode) {
                    // Test mode: Simulate facilitator response
                    updateStatus('ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: í¼ì‹¤ë¦¬í…Œì´í„° ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜ ì¤‘...<br>ì‹¤ì œ íŠ¸ëœì­ì…˜ì€ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'pending');
                    
                    console.log('ğŸ§ª TEST MODE ENABLED');
                    console.log('ğŸ“¦ Payload that would be sent:', payload);
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    facilitatorResult = {
                        success: true,
                        txHash: '0x' + 'a'.repeat(64), // Mock transaction hash
                        message: 'Test mode: Transaction simulated',
                        timestamp: Date.now()
                    };
                    
                    console.log('âœ… Simulated response:', facilitatorResult);

                } else {
                    // Real mode: Send to actual facilitator
                    updateStatus('ğŸ“¤ í¼ì‹¤ë¦¬í…Œì´í„°ì—ê²Œ ì „ì†¡ ì¤‘...<br>í¼ì‹¤ë¦¬í…Œì´í„°ê°€ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤', 'pending');
                    
                    console.log('ğŸ“¤ Sending to facilitator:', facilitatorUrl);
                    console.log('ğŸ“¦ Payload:', payload);
                    
                    const facilitatorResponse = await fetch(facilitatorUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    }).catch(fetchError => {
                        console.error('âŒ Fetch error:', fetchError);
                        throw new Error(`í¼ì‹¤ë¦¬í…Œì´í„° ì—°ê²° ì‹¤íŒ¨. í™•ì¸ì‚¬í•­:\n1. URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n2. í¼ì‹¤ë¦¬í…Œì´í„° ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸\n3. CORS ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n\nError: ${fetchError.message}`);
                    });

                    if (!facilitatorResponse.ok) {
                        const errorText = await facilitatorResponse.text();
                        console.error('âŒ Facilitator response error:', errorText);
                        throw new Error(`í¼ì‹¤ë¦¬í…Œì´í„° ì˜¤ë¥˜: ${facilitatorResponse.status} ${facilitatorResponse.statusText}\nìƒì„¸: ${errorText}`);
                    }

                    facilitatorResult = await facilitatorResponse.json();
                    console.log('âœ… Facilitator response:', facilitatorResult);
                }

                updateStatus(`â³ ${testMode ? 'ì‹œë®¬ë ˆì´ì…˜' : 'í¼ì‹¤ë¦¬í…Œì´í„°'} ì²˜ë¦¬ ì¤‘...<br>íŠ¸ëœì­ì…˜: ${facilitatorResult.txHash || 'pending'}`, 'pending');

                // Wait for confirmation
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Success!
                const successMessage = `
                    <strong>âœ… x402 ê²°ì œ ${testMode ? 'ì‹œë®¬ë ˆì´ì…˜' : 'ì™„ë£Œ'}!</strong><br><br>
                    ${testMode ? '<strong>âš ï¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œ - ì‹¤ì œ íŠ¸ëœì­ì…˜ ì•„ë‹˜</strong><br>' : ''}
                    ğŸ“‹ íŠ¸ëœì­ì…˜: ${facilitatorResult.txHash ? `<a href="https://sepolia.basescan.org/tx/${facilitatorResult.txHash}" target="_blank">${facilitatorResult.txHash.substring(0, 20)}...</a>` : 'Processing'}<br>
                    ğŸ’° ê¸ˆì•¡: ${paymentAmount} ${symbol}<br>
                    ğŸ“ ìˆ˜ì‹ : ${payToAddress.substring(0, 10)}...<br>
                    ${testMode ? '' : `ğŸ¤ í¼ì‹¤ë¦¬í…Œì´í„°: ${payToAddress.substring(0, 10)}...<br>`}
                    <br>
                    <small>${testMode ? 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™œì„±í™” - ì½˜ì†”ì—ì„œ ìì„¸í•œ ë‚´ìš© í™•ì¸' : 'í¼ì‹¤ë¦¬í…Œì´í„°ê°€ ê°€ìŠ¤ë¹„ë¥¼ ëŒ€ì‹  ì§€ë¶ˆí–ˆìŠµë‹ˆë‹¤'}</small>
                `;
                
                updateStatus(successMessage, 'success');

            } catch (error) {
                console.error('âŒ x402 Payment error:', error);
                
                let errorMessage = 'âŒ x402 ê²°ì œ ì‹¤íŒ¨!<br>';
                
                if (error.code === 4001) {
                    errorMessage += 'ì‚¬ìš©ìê°€ ì„œëª…ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤';
                } else if (error.message && error.message.includes('facilitator')) {
                    errorMessage += `í¼ì‹¤ë¦¬í…Œì´í„° ì˜¤ë¥˜: ${error.message}`;
                } else if (error.message && error.message.includes('network')) {
                    errorMessage += 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: í¼ì‹¤ë¦¬í…Œì´í„° ì—”ë“œí¬ì¸íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”';
                } else {
                    errorMessage += `ì˜¤ë¥˜: ${error.message}`;
                }
                
                updateStatus(errorMessage, 'error');
            } finally {
                payNowBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

